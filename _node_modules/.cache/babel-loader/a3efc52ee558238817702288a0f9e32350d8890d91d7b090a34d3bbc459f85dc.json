{"ast":null,"code":"import _regeneratorRuntime from\"/Users/germangurov/projects/wax_bot/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"/Users/germangurov/projects/wax_bot/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";var _=require('lodash');var fetchAllWaxData2=require('../../core/fetchAllWaxData2');var CONTRACTS=require('../consts/CONTRACTS');var fetchBuildings=require('./fetchBuildings');var fetchDistricts=require('./fetchDistricts');var fetchWorkerConfigs=require('./fetchWorkerConfigs');var fetchBuildingConfigs=require('./fetchBuildingConfigs');var fetchWorkers=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(_ref){var _ref$cache,cache,buildingConfigs,workerConfigs,districts,buildings,now,workers;return _regeneratorRuntime().wrap(function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:_ref$cache=_ref.cache,cache=_ref$cache===void 0?{}:_ref$cache;_context.t0=cache.buildingConfigs;if(_context.t0){_context.next=6;break;}_context.next=5;return fetchBuildingConfigs({});case 5:_context.t0=_context.sent;case 6:buildingConfigs=_context.t0;_context.t1=cache.workerConfigs;if(_context.t1){_context.next=12;break;}_context.next=11;return fetchWorkerConfigs({});case 11:_context.t1=_context.sent;case 12:workerConfigs=_context.t1;_context.t2=cache.districts;if(_context.t2){_context.next=18;break;}_context.next=17;return fetchDistricts({});case 17:_context.t2=_context.sent;case 18:districts=_context.t2;_context.t3=cache.buildings;if(_context.t3){_context.next=24;break;}_context.next=23;return fetchBuildings({cache:{buildingConfigs:buildingConfigs,districts:districts}});case 23:_context.t3=_context.sent;case 24:buildings=_context.t3;now=Date.now();_context.next=28;return fetchAllWaxData2({params:{code:CONTRACTS.GAME,scope:CONTRACTS.GAME,table:'worker'},customProcessor:function customProcessor(_ref3){var row=_ref3.row;var shiftStart=row.shift_start*1000;var shiftEnd=row.shift_end*1000;var restEnd=row.rest_end*1000;return{id:row.id,owner:row.owner,assetId:row.asset_id,level:row.level,shiftStart:shiftStart,shiftEnd:shiftEnd,restEnd:restEnd,isWorking:now<shiftEnd,needSleeping:restEnd===0,isSleeping:now<restEnd,district:districts.find(function(district){return district.id===row.district_id;}),config:workerConfigs.find(function(config){return config.id===row.config_id;}),building:buildings.find(function(building){return building.id===row.building_id;})};}});case 28:workers=_context.sent;return _context.abrupt(\"return\",workers);case 30:case\"end\":return _context.stop();}},_callee);}));return function fetchWorkers(_x){return _ref2.apply(this,arguments);};}();module.exports=fetchWorkers;","map":{"version":3,"names":["_","require","fetchAllWaxData2","CONTRACTS","fetchBuildings","fetchDistricts","fetchWorkerConfigs","fetchBuildingConfigs","fetchWorkers","_ref2","_asyncToGenerator","_regeneratorRuntime","mark","_callee","_ref","_ref$cache","cache","buildingConfigs","workerConfigs","districts","buildings","now","workers","wrap","_callee$","_context","prev","next","t0","sent","t1","t2","t3","Date","params","code","GAME","scope","table","customProcessor","_ref3","row","shiftStart","shift_start","shiftEnd","shift_end","restEnd","rest_end","id","owner","assetId","asset_id","level","isWorking","needSleeping","isSleeping","district","find","district_id","config","config_id","building","building_id","abrupt","stop","_x","apply","arguments","module","exports"],"sources":["/Users/germangurov/projects/wax_bot/src/novopangea/api/fetchWorkers.js"],"sourcesContent":["const _ = require('lodash');\nconst fetchAllWaxData2 = require('../../core/fetchAllWaxData2');\nconst CONTRACTS = require('../consts/CONTRACTS');\nconst fetchBuildings = require('./fetchBuildings');\nconst fetchDistricts = require('./fetchDistricts');\nconst fetchWorkerConfigs = require('./fetchWorkerConfigs');\nconst fetchBuildingConfigs = require('./fetchBuildingConfigs');\n\nconst fetchWorkers = async ({\n    cache = {},\n}) => {\n    const buildingConfigs = cache.buildingConfigs || await fetchBuildingConfigs({});\n    const workerConfigs = cache.workerConfigs || await fetchWorkerConfigs({});\n    const districts = cache.districts || await fetchDistricts({});\n    const buildings = cache.buildings || await fetchBuildings({\n        cache: {\n            buildingConfigs,\n            districts,\n        },\n    });\n    \n    const now = Date.now();\n    const workers = await fetchAllWaxData2({\n        params: {\n            code: CONTRACTS.GAME,\n            scope: CONTRACTS.GAME,\n            table: 'worker',\n        },\n        customProcessor: ({row}) => {\n            const shiftStart = row.shift_start * 1000;\n            const shiftEnd = row.shift_end * 1000;\n            const restEnd = row.rest_end * 1000;\n            \n            return {\n                id: row.id,\n                owner: row.owner,\n                assetId: row.asset_id,\n                level: row.level,\n                shiftStart,\n                shiftEnd,\n                restEnd,\n                isWorking: now < shiftEnd,\n                needSleeping: restEnd === 0,\n                isSleeping: now < restEnd,\n                district: districts.find(district => district.id === row.district_id),\n                config: workerConfigs.find(config => config.id === row.config_id),\n                building: buildings.find(building => building.id === row.building_id),\n            };\n        },\n    });\n\n    return workers;\n}\n\nmodule.exports = fetchWorkers;"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}