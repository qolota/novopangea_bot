{"ast":null,"code":"const _ = require('lodash');\nconst fetchBuildings = require('./fetchBuildings');\nconst fetchDistricts = require('./fetchDistricts');\nconst fetchWorkerConfigs = require('./fetchWorkerConfigs');\nconst fetchAccountTransfers = require('./fetchAccountTransfers');\nconst fetchBuildingConfigs = require('./fetchBuildingConfigs');\nconst fetchSpeedupConfigs = require('./fetchSpeedupConfigs');\nconst fetchWorkers = require('./fetchWorkers');\nconst fetchOngoingUpgrades = require('./fetchOngoingUpgrades');\nconst fetchAccountWorkers = async ({\n  accountName,\n  cache = {}\n}) => {\n  const workerConfigs = cache.workerConfigs || (await fetchWorkerConfigs({}));\n  const buildingConfigs = cache.buildingConfigs || (await fetchBuildingConfigs({}));\n  const speedupConfigs = cache.speedupConfigs || (await fetchSpeedupConfigs());\n  const districts = cache.districts || (await fetchDistricts({}));\n  const buildings = cache.buildings || (await fetchBuildings({\n    cache: {\n      buildingConfigs,\n      districts\n    }\n  }));\n  const {\n    workers: staleWorkers\n  } = cache.accountTransfers || (await fetchAccountTransfers({\n    accountName,\n    cache: {\n      workerConfigs,\n      buildingConfigs,\n      speedupConfigs\n    }\n  }));\n  const skilledStaleWorkers = _(staleWorkers).filter(worker => worker.isSkilledWorker).value();\n  const readyToWorkUnskilledWorkers = _(staleWorkers).filter(worker => !worker.isSkilledWorker).value();\n  const readyToWorkWorkers = skilledStaleWorkers;\n\n  // _(skilledStaleWorkers)\n  //     .filter(worker => worker.level >= 4)\n  //     .value();\n  const readyToUpgradeWorkers = _(skilledStaleWorkers).filter(worker => worker.level < 4).value();\n  const workers = cache.workers || (await fetchWorkers({\n    cache: {\n      buildingConfigs,\n      workerConfigs,\n      districts,\n      buildings\n    }\n  }));\n  const upgrades = cache.upgrades || (await fetchOngoingUpgrades({\n    cache: {}\n  }));\n  const ongoingWorkerUpgrades = _(upgrades).filter(upgrade => upgrade.config.schema === 'worker').filter(upgrade => upgrade.owner === accountName).value();\n  const accountWorkers = _(workers).filter(worker => worker.owner === accountName).value();\n  const busyWorkers = _(accountWorkers).filter(worker => worker.isWorking).value();\n  const restWorkers = _(accountWorkers).filter(worker => !worker.isWorking && worker.isSleeping).value();\n  const readyToWakeupWorkers = _(accountWorkers).filter(worker => !worker.isWorking && !worker.needSleeping && !worker.isSleeping).value();\n  // TODO: this is a hack should be fixed properly\n  // we need to get information about worker from AH\n  // but that might be expensive and unstable\n  const readyToRestWorkers = _(accountWorkers).filter(worker => !worker.isWorking && worker.needSleeping).filter(worker => worker.level > 1).value();\n  const readyToRestUnskilledWorkers = _(accountWorkers).filter(worker => !worker.isWorking && worker.needSleeping).filter(worker => worker.level === 1).value();\n  const sets = {\n    busyWorkers,\n    restWorkers,\n    readyToRestWorkers,\n    readyToWakeupWorkers,\n    readyToWorkWorkers,\n    readyToUpgradeWorkers,\n    ongoingWorkerUpgrades,\n    readyToWorkUnskilledWorkers,\n    readyToRestUnskilledWorkers\n  };\n  console.log(`Busy workers: ${busyWorkers.length}`);\n  console.log(`Rest workers: ${restWorkers.length}`);\n  console.log(`Ready to wake up workers: ${readyToWakeupWorkers.length}`);\n  console.log(`Ready to rest skilled workers: ${readyToRestWorkers.length}`);\n  console.log(`Ready to work skilled workers: ${readyToWorkWorkers.length}`);\n  console.log(`Ready to upgrade skilled workers: ${readyToUpgradeWorkers.length}`);\n  console.log(`Ongoing skilled workers upgrades: ${ongoingWorkerUpgrades.length}`);\n  console.log(`Ready to work unskilled workers: ${readyToWorkUnskilledWorkers.length}`);\n  console.log(`Ready to rest unskilled workers: ${readyToRestUnskilledWorkers.length}`);\n  return sets;\n};\nmodule.exports = fetchAccountWorkers;","map":{"version":3,"names":["_","require","fetchBuildings","fetchDistricts","fetchWorkerConfigs","fetchAccountTransfers","fetchBuildingConfigs","fetchSpeedupConfigs","fetchWorkers","fetchOngoingUpgrades","fetchAccountWorkers","accountName","cache","workerConfigs","buildingConfigs","speedupConfigs","districts","buildings","workers","staleWorkers","accountTransfers","skilledStaleWorkers","filter","worker","isSkilledWorker","value","readyToWorkUnskilledWorkers","readyToWorkWorkers","readyToUpgradeWorkers","level","upgrades","ongoingWorkerUpgrades","upgrade","config","schema","owner","accountWorkers","busyWorkers","isWorking","restWorkers","isSleeping","readyToWakeupWorkers","needSleeping","readyToRestWorkers","readyToRestUnskilledWorkers","sets","console","log","length","module","exports"],"sources":["/Users/germangurov/projects/wax_bot/src/novopangea/api/fetchAccountWorkers.js"],"sourcesContent":["const _ = require('lodash');\nconst fetchBuildings = require('./fetchBuildings');\nconst fetchDistricts = require('./fetchDistricts');\nconst fetchWorkerConfigs = require('./fetchWorkerConfigs');\nconst fetchAccountTransfers = require('./fetchAccountTransfers');\nconst fetchBuildingConfigs = require('./fetchBuildingConfigs');\nconst fetchSpeedupConfigs = require('./fetchSpeedupConfigs');\nconst fetchWorkers = require('./fetchWorkers');\nconst fetchOngoingUpgrades = require('./fetchOngoingUpgrades');\n\nconst fetchAccountWorkers = async ({\n    accountName,\n    cache = {},\n}) => {\n    const workerConfigs = cache.workerConfigs || await fetchWorkerConfigs({});\n    const buildingConfigs = cache.buildingConfigs || await fetchBuildingConfigs({});\n    const speedupConfigs = cache.speedupConfigs || await fetchSpeedupConfigs();\n    const districts = cache.districts || await fetchDistricts({});\n    const buildings = cache.buildings || await fetchBuildings({\n        cache: {\n            buildingConfigs,\n            districts,\n        },\n    });\n    const { workers: staleWorkers } = cache.accountTransfers || await fetchAccountTransfers({\n        accountName,\n        cache: {\n            workerConfigs,\n            buildingConfigs,\n            speedupConfigs,\n        },\n    });\n    const skilledStaleWorkers = _(staleWorkers)\n        .filter(worker => worker.isSkilledWorker)\n        .value();\n    const readyToWorkUnskilledWorkers = _(staleWorkers)\n        .filter(worker => !worker.isSkilledWorker)\n        .value();\n    const readyToWorkWorkers = skilledStaleWorkers;\n    \n    // _(skilledStaleWorkers)\n    //     .filter(worker => worker.level >= 4)\n    //     .value();\n    const readyToUpgradeWorkers = _(skilledStaleWorkers)\n        .filter(worker => worker.level < 4)\n        .value();\n    const workers = cache.workers || await fetchWorkers({\n        cache: {\n            buildingConfigs,\n            workerConfigs,\n            districts,\n            buildings,\n        },\n    });\n    const upgrades = cache.upgrades || await fetchOngoingUpgrades({\n        cache: {},\n    });\n    const ongoingWorkerUpgrades = _(upgrades)\n        .filter(upgrade => upgrade.config.schema === 'worker')\n        .filter(upgrade => upgrade.owner === accountName)\n        .value();\n    \n    const accountWorkers = _(workers)\n        .filter(worker => worker.owner === accountName)\n        .value();\n    const busyWorkers = _(accountWorkers)\n        .filter(worker => worker.isWorking)\n        .value();\n    const restWorkers = _(accountWorkers)\n        .filter(worker => !worker.isWorking && worker.isSleeping)\n        .value();\n    const readyToWakeupWorkers = _(accountWorkers)\n        .filter(worker => !worker.isWorking && !worker.needSleeping && !worker.isSleeping)\n        .value();\n    // TODO: this is a hack should be fixed properly\n    // we need to get information about worker from AH\n    // but that might be expensive and unstable\n    const readyToRestWorkers = _(accountWorkers)\n        .filter(worker => !worker.isWorking && worker.needSleeping)\n        .filter(worker => worker.level > 1)\n        .value();\n    const readyToRestUnskilledWorkers = _(accountWorkers)\n        .filter(worker => !worker.isWorking && worker.needSleeping)\n        .filter(worker => worker.level === 1)\n        .value();\n\n    const sets = {\n        busyWorkers,\n        restWorkers,\n        readyToRestWorkers,\n        readyToWakeupWorkers,\n        readyToWorkWorkers,\n        readyToUpgradeWorkers,\n        ongoingWorkerUpgrades,\n        readyToWorkUnskilledWorkers,\n        readyToRestUnskilledWorkers,\n    };\n\n    console.log(`Busy workers: ${busyWorkers.length}`);\n    console.log(`Rest workers: ${restWorkers.length}`);\n    console.log(`Ready to wake up workers: ${readyToWakeupWorkers.length}`);\n    console.log(`Ready to rest skilled workers: ${readyToRestWorkers.length}`);\n    console.log(`Ready to work skilled workers: ${readyToWorkWorkers.length}`);\n    console.log(`Ready to upgrade skilled workers: ${readyToUpgradeWorkers.length}`);\n    console.log(`Ongoing skilled workers upgrades: ${ongoingWorkerUpgrades.length}`);\n    console.log(`Ready to work unskilled workers: ${readyToWorkUnskilledWorkers.length}`);\n    console.log(`Ready to rest unskilled workers: ${readyToRestUnskilledWorkers.length}`);\n\n    return sets;\n};\n\nmodule.exports = fetchAccountWorkers;"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}