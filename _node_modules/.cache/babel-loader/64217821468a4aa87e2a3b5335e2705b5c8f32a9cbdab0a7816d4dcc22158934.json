{"ast":null,"code":"const _ = require('lodash');\nconst setBuildWage = require('./actions/setBuildWage');\nconst wakeupWorkers = require('./actions/wakeupWorkers');\nconst multiplyResources = require('./utils/multiplyResources');\nconst sumResources = require('./utils/sumResources');\nconst exchangeTokens = require('./actions/exchangeTokens');\nconst equalizeResources = require('./utils/equalizeResources');\nconst getExchangeRate = require('./utils/getExchangeRate');\nconst RESOURCES = require('./consts/RESOURSES');\nconst MIN_TRANSACTION_VALUE = require('./consts/MIN_TRANSACTION_VALUE');\nconst EXCHANGE_STRATEGY = require('./consts/EXCHANGE_STRATEGY');\nconst findResource = require('./utils/findResource');\nconst startShift = require('./actions/startShift');\nconst {\n  default: log\n} = require('../utils/log');\nconst renewRent = require('./actions/renewRent');\nconst feedOneWorker = require('./actions/feedOneWorker');\nconst stakeBuilding = require('./actions/stakeBuilding');\nconst fetchAllGameDat = require('./api/fetchAllGameData');\nconst removeBuilding = require('./actions/removeBuilding');\nconst setLandRent = require('./actions/setLandRent');\nconst startUpgrade = require('./actions/startUpgrade');\nconst finishUpgrade = require('./actions/finishUpgrade');\nconst exchangeResources = require('./utils/exchangeResources');\nconst findBuildings = ({\n  buildings,\n  realmName,\n  level,\n  buildingSetName\n}) => {\n  return buildings.find(b => b.realmName === realmName).buildings[level - 1][buildingSetName];\n};\nconst findLands = ({\n  lands,\n  realmName,\n  landSetName\n}) => {\n  return lands.find(land => land.realmName === realmName)[landSetName];\n};\nconst MAX_LAND_RENT_PRICE_OBSD = 0.00000331;\nconst MIN_RENT_BUILDING_LEVELS = {\n  rest: 3,\n  materials: 4,\n  food: 4,\n  energy: 4\n};\nconst OBSD_MIN_BALANCE = 300;\nconst JOB_MIN_PROFITS_OBSD = [2, 4.39400, 6.59100, 7.69000, 0];\nconst REST_MAX_COST_OBSD = [1.1, 1.510, 1.873, 2.055, 0];\n\n// -------------------------------------------------------- //\n// ---------               BALANCE               ---------- //\n// -------------------------------------------------------- //\nconst getTopupObsdAction = ({\n  accountName,\n  exchange,\n  account,\n  gameSettings\n}) => {\n  const obsdBalance = findResource({\n    resources: account.balances,\n    symbol: RESOURCES.OBSD\n  });\n  if (obsdBalance.value > OBSD_MIN_BALANCE) {\n    return;\n  }\n\n  // if OBSD less than 300 convert excess NOVO to OBSD\n  const requestedResources = _(equalizeResources({\n    targetResources: [{\n      value: OBSD_MIN_BALANCE,\n      symbol: RESOURCES.OBSD\n    }],\n    currentResources: account.balances\n  })).map(b => ({\n    value: _.ceil(b.value / MIN_TRANSACTION_VALUE[b.symbol]) * MIN_TRANSACTION_VALUE[b.symbol],\n    symbol: b.symbol\n  })).filter(b => b.value > 0).value();\n  const exchangedRequestedResources = getExchangeRate({\n    exchange,\n    resources: requestedResources,\n    exchangeStrategy: EXCHANGE_STRATEGY\n  });\n  const requestedExchangeResources = equalizeResources({\n    targetResources: sumResources({\n      resources: _(exchangedRequestedResources).map(r => ({\n        value: r.valueFrom,\n        symbol: r.symbolFrom\n      })).value()\n    }),\n    currentResources: account.balances\n  });\n  if (requestedExchangeResources.length > 0) {\n    log({\n      project: gameSettings.name,\n      message: `Not enough resources for topup OBSD: ${requestedExchangeResources.map(r => r.symbol).join(', ')}`\n    });\n    return null;\n  }\n  const actions = _(exchangedRequestedResources).map(r => exchangeTokens({\n    accountName,\n    valueFrom: r.valueFrom,\n    symbolFrom: r.symbolFrom,\n    symbolTo: r.symbolTo\n  })).value();\n  if (actions.length === 0) {\n    return;\n  }\n  return {\n    action: 'topup_obsd',\n    actions\n  };\n};\nconst MAX_OBSD_BALANCE = 20;\nconst getNextStateAfterTransferExcessObsdToNovo = ({\n  prevState,\n  accountName\n}) => {\n  const obsdBalance = findResource({\n    resources: prevState.resources,\n    symbol: RESOURCES.OBSD\n  });\n  if (obsdBalance.value <= MAX_OBSD_BALANCE) {\n    return;\n  }\n  const excessObsResource = {\n    value: _.floor((obsdBalance.value - MAX_OBSD_BALANCE + 3) / MIN_TRANSACTION_VALUE.NOVO) * MIN_TRANSACTION_VALUE.NOVO,\n    symbol: RESOURCES.OBSD\n  };\n  return {\n    action: 'exchange',\n    actions: [exchangeTokens({\n      accountName,\n      valueFrom: excessObsResource.value,\n      symbolFrom: excessObsResource.symbol,\n      symbolTo: RESOURCES.NOVO\n    })],\n    resources: sumResources({\n      resources: [...prevState.resources, {\n        value: -excessObsResource.value,\n        symbol: excessObsResource.symbol\n      }\n      // TODO fix issued not adding NOVO\n      // {\n      //     value: -excessObsResource.value,\n      //     symbol: excessObsResource.symbol,\n      // },\n      ]\n    }),\n\n    availableWorkers: _.cloneDeep(prevState.availableWorkers),\n    availableBuildings: _.cloneDeep(prevState.availableBuildings),\n    availableLands: _.cloneDeep(prevState.availableLands),\n    settings: _.cloneDeep(prevState.settings)\n  };\n};\nconst getNextStateAfterTransferAllResourecesToObsd = ({\n  prevState,\n  exchange,\n  accountName\n}) => {\n  const restBalances = _([RESOURCES.NOVOE, RESOURCES.NOVOM, RESOURCES.NOVOF]).map(symbol => findResource({\n    resources: prevState.resources,\n    symbol\n  })).value();\n  const hasRestResources = _.some(restBalances, b => {\n    return b.value >= MIN_TRANSACTION_VALUE[b.symbol];\n  });\n  if (!hasRestResources) {\n    return;\n  }\n\n  // convert all resources to OBSD\n  const exchangeRestResources = getExchangeRate({\n    exchange,\n    resources: _(restBalances).map(b => ({\n      value: _.floor(b.value / MIN_TRANSACTION_VALUE[b.symbol]) * MIN_TRANSACTION_VALUE[b.symbol],\n      symbol: b.symbol\n    })).filter(b => b.value > 0).value(),\n    exchangeStrategy: EXCHANGE_STRATEGY\n  });\n  const exchangedObsdBalance = sumResources({\n    resources: _(exchangeRestResources).map(r => ({\n      value: r.valueFrom,\n      symbol: r.symbolFrom\n    })).value()\n  });\n  return {\n    action: 'exchange',\n    actions: _(exchangeRestResources).map(b => exchangeTokens({\n      accountName,\n      valueFrom: b.valueTo,\n      symbolFrom: b.symbolTo,\n      symbolTo: b.symbolFrom\n    })).value(),\n    resources: sumResources({\n      resources: [...prevState.resources, ...exchangedObsdBalance, ..._(exchangeRestResources).map(b => ({\n        value: -b.valueTo,\n        symbol: b.symbolTo\n      })).value()]\n    }),\n    availableWorkers: _.cloneDeep(prevState.availableWorkers),\n    availableBuildings: _.cloneDeep(prevState.availableBuildings),\n    availableLands: _.cloneDeep(prevState.availableLands),\n    settings: _.cloneDeep(prevState.settings)\n  };\n};\n\n// -------------------------------------------------------- //\n// ---------                JOB                  ---------- //\n// -------------------------------------------------------- //\nconst getNextStateAfterOwnShiftStart = ({\n  prevState,\n  accountName,\n  exchange,\n  building,\n  worker,\n  account\n}) => {\n  const totalYield = multiplyResources({\n    resources: building.shiftYield.costs,\n    multiplier: worker.config.yieldMultiplier\n  });\n  const nextState = exchangeResources({\n    accountName,\n    exchange,\n    balances: prevState.resources,\n    maxBalances: account.maxBalances,\n    requestedResources: worker.config.shiftCost.costs\n  });\n  if (nextState.action === 'stop') {\n    return nextState;\n  }\n  return {\n    action: 'start_own_shift',\n    actions: [...nextState.actions, startShift({\n      accountName,\n      assetId: worker.assetId,\n      realmId: building.realmId,\n      districtId: building.districtId,\n      buildingId: building.id\n    })],\n    resources: sumResources({\n      resources: [...nextState.nextBalances, ...totalYield]\n    }),\n    availableWorkers: _.cloneDeep(prevState.availableWorkers),\n    availableBuildings: _.cloneDeep(prevState.availableBuildings)\n  };\n};\nconst getNextStateAfterExternalShiftStart = ({\n  prevState,\n  accountName,\n  building,\n  worker,\n  account // TODO validate max storage capacity\n}) => {\n  return {\n    action: 'start_external_shift',\n    actions: [startShift({\n      accountName,\n      assetId: worker.assetId,\n      realmId: building.realmId,\n      districtId: building.districtId,\n      buildingId: building.id\n    })],\n    resources: sumResources({\n      resources: [...prevState.resources,\n      // total shift wage\n      ...multiplyResources({\n        resources: building.contractWage.costs,\n        multiplier: worker.config.wageMultiplier\n      })]\n    }),\n    availableWorkers: _.cloneDeep(prevState.availableWorkers),\n    availableBuildings: _.cloneDeep(prevState.availableBuildings)\n  };\n};\nconst getNextStateAfterShiftStart = ({\n  prevState,\n  accountName,\n  exchange,\n  account\n}) => {\n  if (prevState.availableWorkers.length === 0) {\n    return;\n  }\n  if (prevState.availableBuildings.length === 0) {\n    return;\n  }\n\n  // find a suitable building for a next worker\n  const _prevState = _.cloneDeep(prevState);\n  const worker = _prevState.availableWorkers.pop();\n  const building = _prevState.availableBuildings.pop();\n  building.numWorkers++;\n  if (building.numWorkers < building.maxWorkers) {\n    _prevState.availableBuildings.push(building);\n  }\n  if (building.isOwnBuilding) {\n    return getNextStateAfterOwnShiftStart({\n      prevState: _prevState,\n      accountName,\n      exchange,\n      building,\n      worker,\n      account\n    });\n  }\n  return getNextStateAfterExternalShiftStart({\n    prevState: _prevState,\n    accountName,\n    building,\n    worker,\n    account\n  });\n};\nconst _prepShiftBuildings = ({\n  accountName,\n  buildings,\n  level\n}) => {\n  return _(buildings).map(building => ({\n    id: building.id,\n    realmId: building.district.realm.id,\n    districtId: building.district.id,\n    isOwnBuilding: building.owner === accountName,\n    numWorkers: building.numWorkers,\n    maxWorkers: building.config.workerCapacity,\n    // wage fields for both own and external jobs\n    jobProfitObsd: building.jobProfitObsd,\n    contractWage: building.contractWage,\n    shiftYield: building.config.shiftYield\n  })).filter(building => building.jobProfitObsd > JOB_MIN_PROFITS_OBSD[level - 1]).sortBy(building => building.jobProfitObsd).value();\n};\nconst _getStartMixedShiftAction = ({\n  accountName,\n  exchange,\n  account,\n  gameSettings,\n  realm,\n  actionName\n}) => {\n  const states = [{\n    action: 'init',\n    resources: account.balances,\n    availableWorkers: _.cloneDeep(realm.availableWorkers),\n    availableBuildings: _.cloneDeep(realm.availableBuildings)\n  }];\n  while (true) {\n    const prevState = states[states.length - 1];\n    if (prevState.availableWorkers.length === 0) {\n      break;\n    }\n    if (prevState.availableBuildings.length === 0) {\n      break;\n    }\n    const nextStateTransferExcessObsdToNovo = getNextStateAfterTransferExcessObsdToNovo({\n      prevState,\n      accountName\n    });\n    if (nextStateTransferExcessObsdToNovo != null) {\n      states.push(nextStateTransferExcessObsdToNovo);\n      continue;\n    }\n    const nextStateAfterTransferAllResourecesToObsd = getNextStateAfterTransferAllResourecesToObsd({\n      prevState,\n      exchange,\n      accountName\n    });\n    if (nextStateAfterTransferAllResourecesToObsd != null) {\n      states.push(nextStateAfterTransferAllResourecesToObsd);\n      continue;\n    }\n    const nextStateAfterShiftStart = getNextStateAfterShiftStart({\n      prevState,\n      accountName,\n      exchange,\n      account\n    });\n    if (nextStateAfterShiftStart != null) {\n      if (nextStateAfterShiftStart.action === 'stop') {\n        log({\n          project: gameSettings.name,\n          message: nextStateAfterShiftStart.action.message\n        });\n        break;\n      }\n      states.push(nextStateAfterShiftStart);\n    }\n  }\n\n  // console.log(`Mixed shift states: `, states);\n\n  const actions = _(states).map(state => state.actions).compact().flatten().value();\n  if (actions.length === 0) {\n    return;\n  }\n  return {\n    action: actionName,\n    isMultipleTransactions: true,\n    actions: _.chunk(actions, 16)\n  };\n};\nconst getStartMixedShiftAction = ({\n  accountName,\n  exchange,\n  account,\n  buildings,\n  workers,\n  gameSettings\n}) => {\n  if (workers.length === 0) {\n    return;\n  }\n  const realms = _(workers).groupBy(worker => worker.level).map((workers, level) => {\n    const _level = Number(level);\n    return _(workers).groupBy(worker => worker.realmName).map((workers, realmName) => ({\n      realmName,\n      level: _level,\n      availableWorkers: workers,\n      availableBuildings: _prepShiftBuildings({\n        accountName,\n        buildings: findBuildings({\n          buildings,\n          realmName,\n          level: _level,\n          buildingSetName: 'bestJobBuildings'\n        }),\n        level: _level\n      })\n    })).value();\n  }).flatten().sortBy(realm => -realm.level).value();\n\n  // console.log(`Mix shifts: `, realms);\n\n  // processing one realm at once\n  const realm = realms.find(realm => realm.availableBuildings.length > 0);\n  if (realm == null) {\n    log({\n      project: gameSettings.name,\n      message: `[SKILLED] No available job buildings but ${workers.length} available workers`\n    });\n    return null;\n  }\n  // console.log(`[SKILLED][${realm.realmName}][${realm.level}] Job buildings:`, realm);\n\n  return _getStartMixedShiftAction({\n    accountName,\n    exchange,\n    account,\n    gameSettings,\n    realm,\n    actionName: 'start_mixed_shifts'\n  });\n};\nconst getStartMixedUnskilledShiftAction = ({\n  accountName,\n  exchange,\n  account,\n  buildings,\n  workers,\n  gameSettings\n}) => {\n  if (workers.length === 0) {\n    return;\n  }\n  const realm = {\n    availableWorkers: workers,\n    availableBuildings: _prepShiftBuildings({\n      accountName,\n      buildings,\n      level: 1\n    })\n  };\n  // console.log(`[UNSKILLED] Job buildings: `, realm);\n\n  return _getStartMixedShiftAction({\n    accountName,\n    exchange,\n    account,\n    gameSettings,\n    realm,\n    actionName: 'start_mixed_unskilled_shifts'\n  });\n};\n\n// -------------------------------------------------------- //\n// ---------                REST                 ---------- //\n// -------------------------------------------------------- //\nconst getNextStateAfterRestStart = ({\n  prevState,\n  accountName,\n  exchange,\n  account\n}) => {\n  if (prevState.availableWorkers.length === 0) {\n    return;\n  }\n  if (prevState.availableBuildings.length === 0) {\n    return;\n  }\n\n  // find a suitable building for a next worker\n  const availableWorkers = _.cloneDeep(prevState.availableWorkers);\n  const availableBuildings = _.cloneDeep(prevState.availableBuildings);\n  const worker = availableWorkers.pop();\n  const building = availableBuildings.pop();\n  building.numWorkers++;\n  if (building.numWorkers < building.maxWorkers) {\n    availableBuildings.push(building);\n  }\n\n  // calculate total cost depends on rest building ownership\n  let totalCosts;\n  if (building.isOwnBuilding) {\n    totalCosts = sumResources({\n      resources: [...building.shiftCost.costs, ...worker.config.foodCost.costs]\n    });\n  } else {\n    totalCosts = sumResources({\n      resources: [...building.contractWage.costs, ...worker.config.foodCost.costs]\n    });\n  }\n  const nextState = exchangeResources({\n    accountName,\n    exchange,\n    balances: prevState.resources,\n    maxBalances: account.maxBalances,\n    requestedResources: totalCosts\n  });\n  if (nextState.action === 'stop') {\n    return nextState;\n  }\n  return {\n    action: building.isOwnBuilding ? 'start_own_rest' : 'start_external_rest',\n    actions: [...nextState.actions, feedOneWorker({\n      accountName,\n      buildingId: building.id,\n      workerId: worker.id,\n      realmId: building.realmId,\n      districtId: building.districtId\n    })],\n    resources: sumResources({\n      resources: [...nextState.nextBalances]\n    }),\n    availableWorkers,\n    availableBuildings\n  };\n};\nconst _getStartMixedRestAction = ({\n  accountName,\n  exchange,\n  account,\n  gameSettings,\n  realm,\n  actionName\n}) => {\n  const states = [{\n    action: 'init',\n    resources: account.balances,\n    availableWorkers: _.cloneDeep(realm.availableWorkers),\n    availableBuildings: _.cloneDeep(realm.availableBuildings)\n  }];\n  while (true) {\n    const prevState = states[states.length - 1];\n    if (prevState.availableWorkers.length === 0) {\n      break;\n    }\n    if (prevState.availableBuildings.length === 0) {\n      break;\n    }\n    const nextStateTransferExcessObsdToNovo = getNextStateAfterTransferExcessObsdToNovo({\n      prevState,\n      accountName\n    });\n    if (nextStateTransferExcessObsdToNovo != null) {\n      states.push(nextStateTransferExcessObsdToNovo);\n      continue;\n    }\n    const nextStateAfterTransferAllResourecesToObsd = getNextStateAfterTransferAllResourecesToObsd({\n      prevState,\n      exchange,\n      accountName\n    });\n    if (nextStateAfterTransferAllResourecesToObsd != null) {\n      states.push(nextStateAfterTransferAllResourecesToObsd);\n      continue;\n    }\n    const nextStateAfterRestStart = getNextStateAfterRestStart({\n      prevState,\n      accountName,\n      exchange,\n      account\n    });\n    if (nextStateAfterRestStart != null) {\n      if (nextStateAfterRestStart.action === 'stop') {\n        log({\n          project: gameSettings.name,\n          message: nextStateAfterRestStart.action.message\n        });\n        break;\n      }\n      states.push(nextStateAfterRestStart);\n    }\n  }\n  const actions = _(states).map(state => state.actions).compact().flatten().value();\n  if (actions.length === 0) {\n    return;\n  }\n  return {\n    action: actionName,\n    isMultipleTransactions: true,\n    actions: _.chunk(actions, 16)\n  };\n};\nconst _prepRestBuildings = ({\n  accountName,\n  buildings,\n  level\n}) => {\n  return _(buildings).map(building => ({\n    id: building.id,\n    realmId: building.district.realm.id,\n    districtId: building.district.id,\n    isOwnBuilding: building.owner === accountName,\n    numWorkers: building.numWorkers,\n    maxWorkers: building.config.workerCapacity,\n    // wage fields for both own and external jobs\n    restCostObsd: building.restCostObsd,\n    contractWage: building.contractWage,\n    shiftCost: building.config.shiftCost\n  })).filter(building => building.restCostObsd < REST_MAX_COST_OBSD[level - 1]).sortBy(building => -building.restCostObsd).value();\n};\nconst getStartMixedRestAction = ({\n  accountName,\n  exchange,\n  account,\n  buildings,\n  workers,\n  gameSettings\n}) => {\n  if (workers.length === 0) {\n    return;\n  }\n  const realms = _(workers).groupBy(worker => worker.level).map((workers, level) => {\n    const _level = Number(level);\n    return _(workers).groupBy(worker => worker.district.realm.name).map((workers, realmName) => ({\n      realmName,\n      level: _level,\n      availableWorkers: workers,\n      availableBuildings: _prepRestBuildings({\n        accountName,\n        buildings: findBuildings({\n          buildings,\n          realmName,\n          level: _level,\n          buildingSetName: 'bestRestBuildings'\n        }),\n        level: _level\n      })\n    })).value();\n  }).flatten().sortBy(realm => -realm.level).value();\n\n  // processing one realm at once\n  const realm = realms.find(realm => realm.availableBuildings.length > 0);\n  if (realm == null) {\n    log({\n      project: gameSettings.name,\n      message: `[SKILLED] No available rest buildings but ${workers.length} available workers`\n    });\n    return null;\n  }\n  return _getStartMixedRestAction({\n    accountName,\n    exchange,\n    account,\n    gameSettings,\n    realm,\n    actionName: 'start_mixed_rests'\n  });\n};\nconst getStartMixedUnskilledRestAction = ({\n  accountName,\n  exchange,\n  account,\n  buildings,\n  workers,\n  gameSettings\n}) => {\n  if (workers.length === 0) {\n    return;\n  }\n  const realms = _(workers).groupBy(worker => worker.district.realm.name).map((workers, realmName) => ({\n    realmName,\n    availableWorkers: workers,\n    availableBuildings: _prepRestBuildings({\n      accountName,\n      buildings: findBuildings({\n        buildings,\n        realmName,\n        level: 1,\n        buildingSetName: 'bestUnskilledRestBuildings'\n      }),\n      level: 1\n    })\n  })).value();\n\n  // processing one realm at once\n  const realm = realms.find(realm => realm.availableBuildings.length > 0);\n  if (realm == null) {\n    log({\n      project: gameSettings.name,\n      message: `[UNSKILLED] No available rest buildings but ${workers.length} available workers`\n    });\n    return null;\n  }\n  return _getStartMixedRestAction({\n    accountName,\n    exchange,\n    account,\n    gameSettings,\n    realm,\n    actionName: 'start_mixed_unskilled_rests'\n  });\n};\n\n// -------------------------------------------------------- //\n// ---------                 RENT                ---------- //\n// -------------------------------------------------------- //\nconst getRenewRentAction = ({\n  accountName,\n  exchange,\n  account,\n  buildings,\n  gameSettings\n}) => {\n  if (buildings.length === 0) {\n    return;\n  }\n  const lands = _(buildings).map(building => building.land).value();\n  const totalCosts = sumResources({\n    resources: _(lands).map(land => land.config.plotRentAmount.costs).flatten().value()\n  });\n  const nextState = exchangeResources({\n    accountName,\n    exchange,\n    balances: account.balances,\n    maxBalances: account.maxBalances,\n    requestedResources: totalCosts\n  });\n  if (nextState.action === 'stop') {\n    log({\n      project: gameSettings.name,\n      message: nextState.message\n    });\n    return null;\n  }\n  return {\n    action: 'renew_rent',\n    actions: [...nextState.actions, renewRent({\n      accountName,\n      landIds: _(lands).map(land => land.id).value()\n    })]\n  };\n};\nconst getNextStateAfterRentLandStart = ({\n  prevState,\n  accountName,\n  landConfigs,\n  exchange,\n  account\n}) => {\n  if (prevState.availableBuildings.length === 0) {\n    return;\n  }\n  if (prevState.availableLands.length === 0) {\n    return;\n  }\n\n  // find a suitable building for a next worker\n  const availableBuildings = _.cloneDeep(prevState.availableBuildings);\n  const availableLands = _.cloneDeep(prevState.availableLands);\n  const building = availableBuildings.pop();\n  const land = availableLands.pop();\n  const landConfig = _(landConfigs).sortBy(config => config.rentTime).value()[0];\n\n  // calculate total cost depends on land ownership\n  let totalCosts = [];\n  if (land.isOwnLand) {\n    if (!land.isAvailableForRent) {\n      totalCosts = [...landConfig.plotRentAmount.costs];\n    }\n  } else {\n    totalCosts = [...land.rentCost.costs];\n  }\n  const nextState = exchangeResources({\n    accountName,\n    exchange,\n    balances: prevState.resources,\n    maxBalances: account.maxBalances,\n    requestedResources: totalCosts\n  });\n  if (nextState.action === 'stop') {\n    return nextState;\n  }\n  return {\n    action: land.isOwnLand ? 'start_own_land_rent' : 'start_external_land_rent',\n    actions: _.compact([...nextState.actions, land.isOwnLand && !land.isAvailableForRent ? setLandRent({\n      accountName,\n      id: land.id,\n      rentObsd: 0,\n      isOwnerOccupied: true,\n      landConfigId: landConfig.id\n    }) : null, stakeBuilding({\n      accountName,\n      assetId: building.assetId,\n      realmId: land.realmId,\n      districtId: land.districtId,\n      landId: land.id\n    })]),\n    resources: sumResources({\n      resources: [...nextState.nextBalances]\n    }),\n    availableBuildings,\n    availableLands\n  };\n};\nconst getRentMixedLandsAction = ({\n  accountName,\n  exchange,\n  account,\n  lands,\n  buildings,\n  landConfigs,\n  gameSettings\n}) => {\n  const qualifiedBuildings = _(buildings).filter(building => building.level >= MIN_RENT_BUILDING_LEVELS[building.config.resourceType]).value();\n  if (qualifiedBuildings.length === 0) {\n    return;\n  }\n  const realms = _(qualifiedBuildings).groupBy(building => building.realmName).map((buildings, realmName) => ({\n    realmName,\n    availableBuildings: buildings,\n    availableLands: _(findLands({\n      lands,\n      realmName,\n      landSetName: 'bestLands'\n    })).map(land => ({\n      id: land.id,\n      realmId: land.district.realm.id,\n      districtId: land.district.id,\n      owner: land.owner,\n      isOwnLand: land.owner === accountName,\n      isAvailableForRent: land.isAvailableForRent,\n      rentPriceObsd: land.rentPriceObsd,\n      rentCost: land.rentCost\n    })).filter(land => land.rentPriceObsd < MAX_LAND_RENT_PRICE_OBSD).sortBy(land => -land.rentPriceObsd).value()\n  })).value();\n\n  // process one realm at a time\n  const realm = realms.find(realm => realm.availableLands.length > 0);\n  if (realm == null) {\n    log({\n      project: gameSettings.name,\n      message: `No available lands but ${qualifiedBuildings.length} available buildings: ${qualifiedBuildings.map(b => b.realmName).join(', ')}`\n    });\n    return;\n  }\n  const states = [{\n    action: 'init',\n    resources: account.balances,\n    availableBuildings: _.cloneDeep(realm.availableBuildings),\n    availableLands: _.cloneDeep(realm.availableLands)\n  }];\n  while (true) {\n    const prevState = states[states.length - 1];\n    if (prevState.availableBuildings.length === 0) {\n      break;\n    }\n    if (prevState.availableLands.length === 0) {\n      break;\n    }\n    const nextStateTransferExcessObsdToNovo = getNextStateAfterTransferExcessObsdToNovo({\n      prevState,\n      accountName\n    });\n    if (nextStateTransferExcessObsdToNovo != null) {\n      states.push(nextStateTransferExcessObsdToNovo);\n      continue;\n    }\n    const nextStateAfterTransferAllResourecesToObsd = getNextStateAfterTransferAllResourecesToObsd({\n      prevState,\n      exchange,\n      accountName\n    });\n    if (nextStateAfterTransferAllResourecesToObsd != null) {\n      states.push(nextStateAfterTransferAllResourecesToObsd);\n      continue;\n    }\n    const nextStateAfterRentLandStart = getNextStateAfterRentLandStart({\n      prevState,\n      accountName,\n      exchange,\n      landConfigs,\n      account\n    });\n    if (nextStateAfterRentLandStart != null) {\n      if (nextStateAfterRentLandStart.action === 'stop') {\n        log({\n          project: gameSettings.name,\n          message: nextStateAfterRentLandStart.action.message\n        });\n        break;\n      }\n      states.push(nextStateAfterRentLandStart);\n    }\n  }\n  const actions = _(states).map(state => state.actions).compact().flatten().value();\n  if (actions.length === 0) {\n    return;\n  }\n  return {\n    action: 'rent_mixed_lands',\n    isMultipleTransactions: true,\n    actions: _.chunk(actions, 16)\n  };\n};\n\n// -------------------------------------------------------- //\n// ---------               UPGRADE               ---------- //\n// -------------------------------------------------------- //\n\nconst getNextStateAfterStartWorkerUpgrade = ({\n  prevState,\n  accountName,\n  exchange,\n  account\n}) => {\n  const settings = _.cloneDeep(prevState.settings);\n  const {\n    worker,\n    config\n  } = settings.pop();\n  const nextState = exchangeResources({\n    accountName,\n    exchange,\n    balances: prevState.resources,\n    maxBalances: account.maxBalances,\n    requestedResources: config.upgradeCost.costs\n  });\n  if (nextState.action === 'stop') {\n    return nextState;\n  }\n  return {\n    action: 'upgrading_workers',\n    actions: [...nextState.actions, startUpgrade({\n      accountName,\n      assetId: worker.id\n    })],\n    resources: sumResources({\n      resources: [...nextState.nextBalances]\n    }),\n    settings\n  };\n};\nconst getStartWorkerUpgradesAction = ({\n  account,\n  exchange,\n  accountName,\n  upgradeConfigs,\n  workers,\n  gameSettings\n}) => {\n  if (workers.length === 0) {\n    return;\n  }\n  const settings = _(workers).map(worker => ({\n    worker,\n    config: upgradeConfigs.find(config => config.key === worker.realmName).configs.find(config => config.baseLevel === worker.level)\n  })).value();\n  const states = [{\n    action: 'init',\n    resources: account.balances,\n    settings: _.cloneDeep(settings)\n  }];\n  while (true) {\n    const prevState = states[states.length - 1];\n    if (prevState.settings.length === 0) {\n      break;\n    }\n    const nextStateTransferExcessObsdToNovo = getNextStateAfterTransferExcessObsdToNovo({\n      prevState,\n      accountName\n    });\n    if (nextStateTransferExcessObsdToNovo != null) {\n      states.push(nextStateTransferExcessObsdToNovo);\n      continue;\n    }\n    const nextStateAfterTransferAllResourecesToObsd = getNextStateAfterTransferAllResourecesToObsd({\n      prevState,\n      exchange,\n      accountName\n    });\n    if (nextStateAfterTransferAllResourecesToObsd != null) {\n      states.push(nextStateAfterTransferAllResourecesToObsd);\n      continue;\n    }\n    const nextStateAfterStartWorkerUpgrade = getNextStateAfterStartWorkerUpgrade({\n      prevState,\n      accountName,\n      exchange,\n      account\n    });\n    if (nextStateAfterStartWorkerUpgrade != null) {\n      if (nextStateAfterStartWorkerUpgrade.action === 'stop') {\n        log({\n          project: gameSettings.name,\n          message: nextStateAfterStartWorkerUpgrade.action.message\n        });\n        break;\n      }\n      states.push(nextStateAfterStartWorkerUpgrade);\n    }\n  }\n  const actions = _(states).map(state => state.actions).compact().flatten().value();\n  if (actions.length === 0) {\n    return;\n  }\n  return {\n    action: 'upgrade_workers',\n    isMultipleTransactions: true,\n    actions: _.chunk(actions, 16)\n  };\n};\nconst getFinishUpgradesAction = ({\n  accountName,\n  upgrades\n}) => {\n  const now = Date.now();\n  const finishedUpgrades = _(upgrades).filter(upgrade => upgrade.owner === accountName).filter(upgrade => upgrade.endTime < now).value();\n  if (finishedUpgrades.length === 0) {\n    return;\n  }\n  return {\n    action: 'finish_upgrades',\n    actions: _(finishedUpgrades).map(upgrade => finishUpgrade({\n      accountName,\n      assetId: upgrade.assetId\n    })).value()\n  };\n};\n\n// -------------------------------------------------------- //\n// ---------             ENTRY POIN              ---------- //\n// -------------------------------------------------------- //\nconst playGameCalcNextAction = async ({\n  accountName,\n  gameSettings\n}) => {\n  const {\n    exchange,\n    account,\n    accountBuildings,\n    accountWorkers,\n    accountLands,\n    accountTransfers,\n    landConfigs,\n    upgradeConfigs,\n    upgrades\n  } = await fetchAllGameDat({\n    accountName\n  });\n\n  // showing alert if some buildings places in district with inappropriate town hall level\n  if (accountBuildings.ownStaleBuildings.length > 0) {\n    const staleRealms = _(accountBuildings.ownStaleBuildings).map(building => building.district.realm.name).uniq().value();\n    log({\n      project: gameSettings.name,\n      message: `[ACTION NEEDED] ${accountBuildings.ownStaleBuildings.length} stale buildings, need to be moved to another district, relams: ${staleRealms.join(', ')}`\n    });\n  }\n\n  // wake up all available workers\n  if (accountWorkers.readyToWakeupWorkers.length > 0) {\n    return {\n      action: 'wakeup',\n      actions: [wakeupWorkers({\n        accountName,\n        workerIds: _(accountWorkers.readyToWakeupWorkers).map(worker => worker.id).value()\n      })]\n    };\n  }\n\n  // set wage for all avaialbe buildings\n  if (accountBuildings.ownBuildingsWithoutWageSet.length > 0) {\n    return {\n      action: 'set_building_wage',\n      actions: _(accountBuildings.ownBuildingsWithoutWageSet).map(b => setBuildWage({\n        accountName,\n        id: b.id,\n        wageObsd: b.config.minimumWage.obsdCost,\n        isOnlyOwnWorkersAllowed: true,\n        minWorkerLevel: 1\n      })).value()\n    };\n  }\n\n  // prolong rent for buildings placed on your lands\n  if (accountBuildings.ownBuildingsExpiredExternalRentSet.length > 0) {\n    return {\n      action: 'cancel_external_rent',\n      actions: _(accountBuildings.ownBuildingsExpiredExternalRentSet).map(building => removeBuilding({\n        accountName,\n        buildingId: building.id\n      })).value()\n    };\n  }\n  const startMixedShiftsAction = getStartMixedShiftAction({\n    accountName,\n    exchange,\n    account,\n    buildings: accountBuildings.buildings,\n    workers: [...accountWorkers.readyToWorkWorkers],\n    gameSettings\n  });\n  const startMixedUnskilledShiftsAction = getStartMixedUnskilledShiftAction({\n    accountName,\n    exchange,\n    account,\n    buildings: accountBuildings.unskilledJobBuildings,\n    workers: accountWorkers.readyToWorkUnskilledWorkers,\n    gameSettings\n  });\n  const startMixedUnskilledRestAction = getStartMixedUnskilledRestAction({\n    accountName,\n    exchange,\n    account,\n    buildings: accountBuildings.buildings,\n    workers: accountWorkers.readyToRestUnskilledWorkers,\n    gameSettings\n  });\n  const startMixedRestsAction = getStartMixedRestAction({\n    accountName,\n    exchange,\n    account,\n    buildings: accountBuildings.buildings,\n    workers: accountWorkers.readyToRestWorkers,\n    gameSettings\n  });\n  const startRenewRentAction = getRenewRentAction({\n    accountName,\n    exchange,\n    account,\n    buildings: accountBuildings.ownBuildingsExpiredRentSet,\n    gameSettings\n  });\n  const rentExternalLandsAction = getRentMixedLandsAction({\n    accountName,\n    exchange,\n    account,\n    lands: accountLands.lands,\n    buildings: accountTransfers.buildings,\n    landConfigs,\n    gameSettings\n  });\n  const startWorkerUpgradesAction = getStartWorkerUpgradesAction({\n    account,\n    exchange,\n    accountName,\n    upgradeConfigs: upgradeConfigs.workers,\n    workers: accountWorkers.readyToUpgradeWorkers,\n    gameSettings\n  });\n  const finishUpgradesAction = getFinishUpgradesAction({\n    accountName,\n    upgrades\n  });\n  if (finishUpgradesAction != null) {\n    return finishUpgradesAction;\n  }\n  if (startWorkerUpgradesAction != null) {\n    return startWorkerUpgradesAction;\n  }\n  if (rentExternalLandsAction != null) {\n    return rentExternalLandsAction;\n  }\n  if (startMixedRestsAction != null) {\n    return startMixedRestsAction;\n  }\n  if (startMixedUnskilledRestAction != null) {\n    return startMixedUnskilledRestAction;\n  }\n  if (startRenewRentAction != null) {\n    return startRenewRentAction;\n  }\n  if (startMixedShiftsAction != null) {\n    return startMixedShiftsAction;\n  }\n  if (startMixedUnskilledShiftsAction != null) {\n    return startMixedUnskilledShiftsAction;\n  }\n  return {\n    action: 'wait',\n    message: `Nothing to do for ${accountName}`\n  };\n};\nmodule.exports = playGameCalcNextAction;","map":{"version":3,"names":["_","require","setBuildWage","wakeupWorkers","multiplyResources","sumResources","exchangeTokens","equalizeResources","getExchangeRate","RESOURCES","MIN_TRANSACTION_VALUE","EXCHANGE_STRATEGY","findResource","startShift","default","log","renewRent","feedOneWorker","stakeBuilding","fetchAllGameDat","removeBuilding","setLandRent","startUpgrade","finishUpgrade","exchangeResources","findBuildings","buildings","realmName","level","buildingSetName","find","b","findLands","lands","landSetName","land","MAX_LAND_RENT_PRICE_OBSD","MIN_RENT_BUILDING_LEVELS","rest","materials","food","energy","OBSD_MIN_BALANCE","JOB_MIN_PROFITS_OBSD","REST_MAX_COST_OBSD","getTopupObsdAction","accountName","exchange","account","gameSettings","obsdBalance","resources","balances","symbol","OBSD","value","requestedResources","targetResources","currentResources","map","ceil","filter","exchangedRequestedResources","exchangeStrategy","requestedExchangeResources","r","valueFrom","symbolFrom","length","project","name","message","join","actions","symbolTo","action","MAX_OBSD_BALANCE","getNextStateAfterTransferExcessObsdToNovo","prevState","excessObsResource","floor","NOVO","availableWorkers","cloneDeep","availableBuildings","availableLands","settings","getNextStateAfterTransferAllResourecesToObsd","restBalances","NOVOE","NOVOM","NOVOF","hasRestResources","some","exchangeRestResources","exchangedObsdBalance","valueTo","getNextStateAfterOwnShiftStart","building","worker","totalYield","shiftYield","costs","multiplier","config","yieldMultiplier","nextState","maxBalances","shiftCost","assetId","realmId","districtId","buildingId","id","nextBalances","getNextStateAfterExternalShiftStart","contractWage","wageMultiplier","getNextStateAfterShiftStart","_prevState","pop","numWorkers","maxWorkers","push","isOwnBuilding","_prepShiftBuildings","district","realm","owner","workerCapacity","jobProfitObsd","sortBy","_getStartMixedShiftAction","actionName","states","nextStateTransferExcessObsdToNovo","nextStateAfterTransferAllResourecesToObsd","nextStateAfterShiftStart","state","compact","flatten","isMultipleTransactions","chunk","getStartMixedShiftAction","workers","realms","groupBy","_level","Number","getStartMixedUnskilledShiftAction","getNextStateAfterRestStart","totalCosts","foodCost","workerId","_getStartMixedRestAction","nextStateAfterRestStart","_prepRestBuildings","restCostObsd","getStartMixedRestAction","getStartMixedUnskilledRestAction","getRenewRentAction","plotRentAmount","landIds","getNextStateAfterRentLandStart","landConfigs","landConfig","rentTime","isOwnLand","isAvailableForRent","rentCost","rentObsd","isOwnerOccupied","landConfigId","landId","getRentMixedLandsAction","qualifiedBuildings","resourceType","rentPriceObsd","nextStateAfterRentLandStart","getNextStateAfterStartWorkerUpgrade","upgradeCost","getStartWorkerUpgradesAction","upgradeConfigs","key","configs","baseLevel","nextStateAfterStartWorkerUpgrade","getFinishUpgradesAction","upgrades","now","Date","finishedUpgrades","upgrade","endTime","playGameCalcNextAction","accountBuildings","accountWorkers","accountLands","accountTransfers","ownStaleBuildings","staleRealms","uniq","readyToWakeupWorkers","workerIds","ownBuildingsWithoutWageSet","wageObsd","minimumWage","obsdCost","isOnlyOwnWorkersAllowed","minWorkerLevel","ownBuildingsExpiredExternalRentSet","startMixedShiftsAction","readyToWorkWorkers","startMixedUnskilledShiftsAction","unskilledJobBuildings","readyToWorkUnskilledWorkers","startMixedUnskilledRestAction","readyToRestUnskilledWorkers","startMixedRestsAction","readyToRestWorkers","startRenewRentAction","ownBuildingsExpiredRentSet","rentExternalLandsAction","startWorkerUpgradesAction","readyToUpgradeWorkers","finishUpgradesAction","module","exports"],"sources":["/Users/germangurov/projects/wax_bot/src/novopangea/playGameCalcNextAction.js"],"sourcesContent":["const _ = require('lodash');\nconst setBuildWage = require('./actions/setBuildWage');\nconst wakeupWorkers = require('./actions/wakeupWorkers');\nconst multiplyResources = require('./utils/multiplyResources');\nconst sumResources = require('./utils/sumResources');\nconst exchangeTokens = require('./actions/exchangeTokens');\nconst equalizeResources = require('./utils/equalizeResources');\nconst getExchangeRate = require('./utils/getExchangeRate');\nconst RESOURCES = require('./consts/RESOURSES');\nconst MIN_TRANSACTION_VALUE = require('./consts/MIN_TRANSACTION_VALUE');\nconst EXCHANGE_STRATEGY = require('./consts/EXCHANGE_STRATEGY');\nconst findResource = require('./utils/findResource');\nconst startShift = require('./actions/startShift');\nconst { default: log} = require('../utils/log');\nconst renewRent = require('./actions/renewRent');\nconst feedOneWorker = require('./actions/feedOneWorker');\nconst stakeBuilding = require('./actions/stakeBuilding');\nconst fetchAllGameDat = require('./api/fetchAllGameData');\nconst removeBuilding = require('./actions/removeBuilding');\nconst setLandRent = require('./actions/setLandRent');\nconst startUpgrade = require('./actions/startUpgrade');\nconst finishUpgrade = require('./actions/finishUpgrade');\nconst exchangeResources = require('./utils/exchangeResources');\n\nconst findBuildings = ({\n    buildings,\n    realmName,\n    level,\n    buildingSetName,\n}) => {\n    return buildings\n        .find(b => b.realmName === realmName)\n        .buildings[level - 1][buildingSetName];\n};\n\nconst findLands = ({\n    lands,\n    realmName,\n    landSetName,\n}) => {\n    return lands.find(land => land.realmName === realmName)[landSetName];\n};\n\nconst MAX_LAND_RENT_PRICE_OBSD = 0.00000331;\nconst MIN_RENT_BUILDING_LEVELS = {\n    rest: 3,\n    materials: 4,\n    food: 4,\n    energy: 4,\n};\nconst OBSD_MIN_BALANCE = 300;\nconst JOB_MIN_PROFITS_OBSD = [\n    2,\n    4.39400,\n    6.59100,\n    7.69000,\n    0,\n];\n\nconst REST_MAX_COST_OBSD = [\n    1.1,\n    1.510,\n    1.873,\n    2.055,\n    0,\n];\n\n// -------------------------------------------------------- //\n// ---------               BALANCE               ---------- //\n// -------------------------------------------------------- //\nconst getTopupObsdAction = ({\n    accountName,\n    exchange,\n    account,\n    gameSettings,\n}) => {\n    const obsdBalance = findResource({\n        resources: account.balances,\n        symbol: RESOURCES.OBSD,\n    });\n    \n    if (obsdBalance.value > OBSD_MIN_BALANCE) {\n        return;\n    }\n\n    // if OBSD less than 300 convert excess NOVO to OBSD\n    const requestedResources = _(equalizeResources({\n        targetResources: [\n            {\n                value: OBSD_MIN_BALANCE,\n                symbol: RESOURCES.OBSD,\n            },\n        ],\n        currentResources: account.balances,\n    }))\n        .map(b => ({\n            value: _.ceil(b.value / MIN_TRANSACTION_VALUE[b.symbol]) * MIN_TRANSACTION_VALUE[b.symbol],\n            symbol: b.symbol,\n        }))\n        .filter(b => b.value > 0)\n        .value();\n    const exchangedRequestedResources = getExchangeRate({\n        exchange,\n        resources: requestedResources,\n        exchangeStrategy: EXCHANGE_STRATEGY,\n    });\n    const requestedExchangeResources = equalizeResources({\n        targetResources: sumResources({\n            resources: _(exchangedRequestedResources)\n                .map(r => ({\n                    value: r.valueFrom,\n                    symbol: r.symbolFrom,\n                }))\n                .value(),\n        }),\n        currentResources: account.balances,\n    });\n\n    if (requestedExchangeResources.length > 0) {\n        log({\n            project: gameSettings.name,\n            message: `Not enough resources for topup OBSD: ${requestedExchangeResources.map(r => r.symbol).join(', ')}`,\n        });\n        return null;\n    }\n\n    const actions = _(exchangedRequestedResources)\n        .map(r => exchangeTokens({\n            accountName,\n            valueFrom: r.valueFrom,\n            symbolFrom: r.symbolFrom,\n            symbolTo: r.symbolTo,\n        }))\n        .value();\n    \n    if (actions.length === 0) {\n        return;\n    }\n\n    return {\n        action: 'topup_obsd',\n        actions,\n    };\n};\n\nconst MAX_OBSD_BALANCE = 20;\n\nconst getNextStateAfterTransferExcessObsdToNovo = ({\n    prevState,\n    accountName,\n}) => {\n    const obsdBalance = findResource({\n        resources: prevState.resources,\n        symbol: RESOURCES.OBSD,\n    });\n    \n    if (obsdBalance.value <= MAX_OBSD_BALANCE) {\n        return;\n    }\n\n    const excessObsResource = {\n        value: _.floor((obsdBalance.value - MAX_OBSD_BALANCE + 3) / MIN_TRANSACTION_VALUE.NOVO) * MIN_TRANSACTION_VALUE.NOVO,\n        symbol: RESOURCES.OBSD,\n    };\n\n    return {\n        action: 'exchange',\n        actions: [\n            exchangeTokens({\n                accountName,\n                valueFrom: excessObsResource.value,\n                symbolFrom: excessObsResource.symbol,\n                symbolTo: RESOURCES.NOVO,\n            }),\n        ],\n        resources: sumResources({\n            resources: [\n                ...prevState.resources,\n                {\n                    value: -excessObsResource.value,\n                    symbol: excessObsResource.symbol,\n                },\n                // TODO fix issued not adding NOVO\n                // {\n                //     value: -excessObsResource.value,\n                //     symbol: excessObsResource.symbol,\n                // },\n            ],\n        }),\n        availableWorkers: _.cloneDeep(prevState.availableWorkers),\n        availableBuildings: _.cloneDeep(prevState.availableBuildings),\n        availableLands: _.cloneDeep(prevState.availableLands),\n        settings: _.cloneDeep(prevState.settings),\n    };\n};\n\nconst getNextStateAfterTransferAllResourecesToObsd = ({\n    prevState,\n    exchange,\n    accountName,\n}) => {\n    const restBalances = _([\n        RESOURCES.NOVOE,\n        RESOURCES.NOVOM,\n        RESOURCES.NOVOF,\n    ])\n        .map(symbol => findResource({\n            resources: prevState.resources,\n            symbol,\n        }))\n        .value();\n    const hasRestResources = _.some(restBalances, b => {\n        return b.value >= MIN_TRANSACTION_VALUE[b.symbol];\n    });\n\n    if (!hasRestResources) {\n        return;\n    }\n\n    // convert all resources to OBSD\n    const exchangeRestResources = getExchangeRate({\n        exchange,\n        resources: _(restBalances)\n            .map(b => ({\n                value: _.floor(b.value / MIN_TRANSACTION_VALUE[b.symbol]) * MIN_TRANSACTION_VALUE[b.symbol],\n                symbol: b.symbol,\n            }))\n            .filter(b => b.value > 0)\n            .value(),\n        exchangeStrategy: EXCHANGE_STRATEGY,\n    });\n    const exchangedObsdBalance = sumResources({\n        resources: _(exchangeRestResources)\n            .map(r => ({\n                value: r.valueFrom,\n                symbol: r.symbolFrom,\n            }))\n            .value(),\n    });\n\n    return {\n        action: 'exchange',\n        actions: _(exchangeRestResources)\n            .map(b => exchangeTokens({\n                accountName,\n                valueFrom: b.valueTo,\n                symbolFrom: b.symbolTo,\n                symbolTo: b.symbolFrom,\n            }))\n            .value(),\n        resources: sumResources({\n            resources: [\n                ...prevState.resources,\n                ...exchangedObsdBalance,\n                ..._(exchangeRestResources)\n                    .map(b => ({\n                        value: -b.valueTo,\n                        symbol: b.symbolTo,\n                    }))\n                    .value(),\n            ],\n        }),\n        availableWorkers: _.cloneDeep(prevState.availableWorkers),\n        availableBuildings: _.cloneDeep(prevState.availableBuildings),\n        availableLands: _.cloneDeep(prevState.availableLands),\n        settings: _.cloneDeep(prevState.settings),\n    };\n};\n\n// -------------------------------------------------------- //\n// ---------                JOB                  ---------- //\n// -------------------------------------------------------- //\nconst getNextStateAfterOwnShiftStart = ({\n    prevState,\n    accountName,\n    exchange,\n    building,\n    worker,\n    account,\n}) => {\n    const totalYield = multiplyResources({\n        resources: building.shiftYield.costs,\n        multiplier: worker.config.yieldMultiplier,\n    });\n\n    const nextState = exchangeResources({\n        accountName,\n        exchange,\n        balances: prevState.resources,\n        maxBalances: account.maxBalances,\n        requestedResources: worker.config.shiftCost.costs,\n    });\n\n    if (nextState.action === 'stop') {\n        return nextState;\n    }\n\n    return {\n        action: 'start_own_shift',\n        actions: [\n            ...nextState.actions,\n            startShift({\n                accountName,\n                assetId: worker.assetId,\n                realmId: building.realmId,\n                districtId: building.districtId,\n                buildingId: building.id,\n            }),\n        ],\n        resources: sumResources({\n            resources: [\n                ...nextState.nextBalances,\n                ...totalYield,\n            ],\n        }),\n        availableWorkers: _.cloneDeep(prevState.availableWorkers),\n        availableBuildings: _.cloneDeep(prevState.availableBuildings),\n    };\n};\n\nconst getNextStateAfterExternalShiftStart = ({\n    prevState,\n    accountName,\n    building,\n    worker,\n    account, // TODO validate max storage capacity\n}) => {\n    return {\n        action: 'start_external_shift',\n        actions: [\n            startShift({\n                accountName,\n                assetId: worker.assetId,\n                realmId: building.realmId,\n                districtId: building.districtId,\n                buildingId: building.id,\n            }),\n        ],\n        resources: sumResources({\n            resources: [\n                ...prevState.resources,\n                // total shift wage\n                ...multiplyResources({\n                    resources: building.contractWage.costs,\n                    multiplier: worker.config.wageMultiplier,\n                }),\n            ],\n        }),\n        availableWorkers: _.cloneDeep(prevState.availableWorkers),\n        availableBuildings: _.cloneDeep(prevState.availableBuildings),\n    };\n};\n\nconst getNextStateAfterShiftStart = ({\n    prevState,\n    accountName,\n    exchange,\n    account,\n}) => {\n    if (prevState.availableWorkers.length === 0) {\n        return;\n    }\n\n    if (prevState.availableBuildings.length === 0) {\n        return;\n    }\n\n    // find a suitable building for a next worker\n    const _prevState = _.cloneDeep(prevState);\n    const worker = _prevState.availableWorkers.pop();\n    const building = _prevState.availableBuildings.pop();\n    building.numWorkers++;\n\n    if (building.numWorkers < building.maxWorkers) {\n        _prevState.availableBuildings.push(building);\n    }\n\n    if (building.isOwnBuilding) {\n        return getNextStateAfterOwnShiftStart({\n            prevState: _prevState,\n            accountName,\n            exchange,\n            building,\n            worker,\n            account,\n        });\n    }\n\n    return getNextStateAfterExternalShiftStart({\n        prevState: _prevState,\n        accountName,\n        building,\n        worker,\n        account,\n    });\n};\n\nconst _prepShiftBuildings = ({\n    accountName,\n    buildings,\n    level,\n}) => {\n    return _(buildings)\n        .map(building => ({\n            id: building.id,\n            realmId: building.district.realm.id,\n            districtId: building.district.id,\n            isOwnBuilding: building.owner === accountName,\n            numWorkers: building.numWorkers,\n            maxWorkers: building.config.workerCapacity,\n            // wage fields for both own and external jobs\n            jobProfitObsd: building.jobProfitObsd,\n            contractWage: building.contractWage,\n            shiftYield: building.config.shiftYield,\n        }))\n        .filter(building => building.jobProfitObsd > JOB_MIN_PROFITS_OBSD[level - 1])\n        .sortBy(building => building.jobProfitObsd)\n        .value();\n};\n\nconst _getStartMixedShiftAction = ({\n    accountName,\n    exchange,\n    account,\n    gameSettings,\n    realm,\n    actionName,\n}) => {\n    const states = [\n        {\n            action: 'init',\n            resources: account.balances,\n            availableWorkers: _.cloneDeep(realm.availableWorkers),\n            availableBuildings: _.cloneDeep(realm.availableBuildings),\n        },\n    ];\n\n    while (true) {\n        const prevState = states[states.length - 1];\n\n        if (prevState.availableWorkers.length === 0) {\n            break;\n        }\n        if (prevState.availableBuildings.length === 0) {\n            break;\n        }\n\n        const nextStateTransferExcessObsdToNovo = getNextStateAfterTransferExcessObsdToNovo({\n            prevState,\n            accountName,\n        });\n\n        if (nextStateTransferExcessObsdToNovo != null) {\n            states.push(nextStateTransferExcessObsdToNovo);\n            continue;\n        }\n\n        const nextStateAfterTransferAllResourecesToObsd = getNextStateAfterTransferAllResourecesToObsd({\n            prevState,\n            exchange,\n            accountName,\n        });\n\n        if (nextStateAfterTransferAllResourecesToObsd != null) {\n            states.push(nextStateAfterTransferAllResourecesToObsd);\n            continue;\n        }\n\n        const nextStateAfterShiftStart = getNextStateAfterShiftStart({\n            prevState,\n            accountName,\n            exchange,\n            account,\n        });\n\n        if (nextStateAfterShiftStart != null) {\n            if (nextStateAfterShiftStart.action === 'stop') {\n                log({\n                    project: gameSettings.name,\n                    message: nextStateAfterShiftStart.action.message,\n                });\n                break;\n            }\n\n            states.push(nextStateAfterShiftStart);\n        }\n    }\n\n    // console.log(`Mixed shift states: `, states);\n\n    const actions = _(states)\n        .map(state => state.actions)\n        .compact()\n        .flatten()\n        .value();\n    \n    if (actions.length === 0) {\n        return;\n    }\n\n    return {\n        action: actionName,\n        isMultipleTransactions: true,\n        actions: _.chunk(actions, 16),\n    };\n};\n\nconst getStartMixedShiftAction = ({\n    accountName,\n    exchange,\n    account,\n    buildings,\n    workers,\n    gameSettings,\n}) => {\n    if (workers.length === 0) {\n        return;\n    }\n\n    const realms = _(workers)\n        .groupBy(worker => worker.level)\n        .map((workers, level) => {\n            const _level = Number(level);\n            return _(workers)\n                .groupBy(worker => worker.realmName)\n                .map((workers, realmName) => ({\n                    realmName,\n                    level: _level,\n                    availableWorkers: workers,\n                    availableBuildings: _prepShiftBuildings({\n                        accountName,\n                        buildings: findBuildings({\n                            buildings,\n                            realmName,\n                            level: _level,\n                            buildingSetName: 'bestJobBuildings'\n                        }),\n                        level: _level,\n                    }),\n                }))\n                .value();\n        })\n        .flatten()\n        .sortBy(realm => -realm.level)\n        .value();\n\n    // console.log(`Mix shifts: `, realms);\n    \n    // processing one realm at once\n    const realm = realms.find(realm => realm.availableBuildings.length > 0);\n    \n    if (realm == null) {\n        log({\n            project: gameSettings.name,\n            message: `[SKILLED] No available job buildings but ${workers.length} available workers`,\n        });\n        return null;\n    }\n    // console.log(`[SKILLED][${realm.realmName}][${realm.level}] Job buildings:`, realm);\n\n    return _getStartMixedShiftAction({\n        accountName,\n        exchange,\n        account,\n        gameSettings,\n        realm,\n        actionName: 'start_mixed_shifts',\n    });\n};\n\nconst getStartMixedUnskilledShiftAction = ({\n    accountName,\n    exchange,\n    account,\n    buildings,\n    workers,\n    gameSettings,\n}) => {\n    if (workers.length === 0) {\n        return;\n    }\n    \n    const realm = {\n        availableWorkers: workers,\n        availableBuildings: _prepShiftBuildings({\n            accountName,\n            buildings,\n            level: 1,\n        }),\n    };\n    // console.log(`[UNSKILLED] Job buildings: `, realm);\n\n    return _getStartMixedShiftAction({\n        accountName,\n        exchange,\n        account,\n        gameSettings,\n        realm,\n        actionName: 'start_mixed_unskilled_shifts',\n    });\n};\n\n// -------------------------------------------------------- //\n// ---------                REST                 ---------- //\n// -------------------------------------------------------- //\nconst getNextStateAfterRestStart = ({\n    prevState,\n    accountName,\n    exchange,\n    account,\n}) => {\n    if (prevState.availableWorkers.length === 0) {\n        return;\n    }\n\n    if (prevState.availableBuildings.length === 0) {\n        return;\n    }\n\n    // find a suitable building for a next worker\n    const availableWorkers = _.cloneDeep(prevState.availableWorkers);\n    const availableBuildings = _.cloneDeep(prevState.availableBuildings);\n    const worker = availableWorkers.pop();\n    const building = availableBuildings.pop();\n    building.numWorkers++;\n\n    if (building.numWorkers < building.maxWorkers) {\n        availableBuildings.push(building);\n    }\n\n    // calculate total cost depends on rest building ownership\n    let totalCosts;\n    if (building.isOwnBuilding) {\n        totalCosts = sumResources({\n            resources: [\n                ...building.shiftCost.costs,\n                ...worker.config.foodCost.costs,\n            ],\n        });\n    } else {\n        totalCosts = sumResources({\n            resources: [\n                ...building.contractWage.costs,\n                ...worker.config.foodCost.costs,\n            ],\n        });\n    }\n\n    const nextState = exchangeResources({\n        accountName,\n        exchange,\n        balances: prevState.resources,\n        maxBalances: account.maxBalances,\n        requestedResources: totalCosts,\n    });\n\n    if (nextState.action === 'stop') {\n        return nextState;\n    }\n\n    return {\n        action: building.isOwnBuilding\n            ? 'start_own_rest'\n            : 'start_external_rest',\n        actions: [\n            ...nextState.actions,\n            feedOneWorker({\n                accountName,\n                buildingId: building.id,\n                workerId: worker.id,\n                realmId: building.realmId,\n                districtId: building.districtId,\n            }),\n        ],\n        resources: sumResources({\n            resources: [\n                ...nextState.nextBalances,\n            ],\n        }),\n        availableWorkers,\n        availableBuildings,\n    };\n};\n\nconst _getStartMixedRestAction = ({\n    accountName,\n    exchange,\n    account,\n    gameSettings,\n    realm,\n    actionName,\n}) => {\n    const states = [\n        {\n            action: 'init',\n            resources: account.balances,\n            availableWorkers: _.cloneDeep(realm.availableWorkers),\n            availableBuildings: _.cloneDeep(realm.availableBuildings),\n        },\n    ];\n\n    while (true) {\n        const prevState = states[states.length - 1];\n\n        if (prevState.availableWorkers.length === 0) {\n            break;\n        }\n        if (prevState.availableBuildings.length === 0) {\n            break;\n        }\n\n        const nextStateTransferExcessObsdToNovo = getNextStateAfterTransferExcessObsdToNovo({\n            prevState,\n            accountName,\n        });\n\n        if (nextStateTransferExcessObsdToNovo != null) {\n            states.push(nextStateTransferExcessObsdToNovo);\n            continue;\n        }\n\n        const nextStateAfterTransferAllResourecesToObsd = getNextStateAfterTransferAllResourecesToObsd({\n            prevState,\n            exchange,\n            accountName,\n        });\n\n        if (nextStateAfterTransferAllResourecesToObsd != null) {\n            states.push(nextStateAfterTransferAllResourecesToObsd);\n            continue;\n        }\n\n        const nextStateAfterRestStart = getNextStateAfterRestStart({\n            prevState,\n            accountName,\n            exchange,\n            account,\n        });\n\n        if (nextStateAfterRestStart != null) {\n            if (nextStateAfterRestStart.action === 'stop') {\n                log({\n                    project: gameSettings.name,\n                    message: nextStateAfterRestStart.action.message,\n                });\n                break;\n            }\n\n            states.push(nextStateAfterRestStart);\n        }\n    }\n\n    const actions = _(states)\n        .map(state => state.actions)\n        .compact()\n        .flatten()\n        .value();\n    \n    if (actions.length === 0) {\n        return;\n    }\n    \n    return {\n        action: actionName,\n        isMultipleTransactions: true,\n        actions: _.chunk(actions, 16),\n    };\n};\n\nconst _prepRestBuildings = ({\n    accountName,\n    buildings,\n    level,\n}) => {\n    return _(buildings)\n        .map(building => ({\n            id: building.id,\n            realmId: building.district.realm.id,\n            districtId: building.district.id,\n            isOwnBuilding: building.owner === accountName,\n            numWorkers: building.numWorkers,\n            maxWorkers: building.config.workerCapacity,\n            // wage fields for both own and external jobs\n            restCostObsd: building.restCostObsd,\n            contractWage: building.contractWage,\n            shiftCost: building.config.shiftCost,\n        }))\n        .filter(building => building.restCostObsd < REST_MAX_COST_OBSD[level - 1])\n        .sortBy(building => -building.restCostObsd)\n        .value();\n};\n\nconst getStartMixedRestAction = ({\n    accountName,\n    exchange,\n    account,\n    buildings,\n    workers,\n    gameSettings,\n}) => {\n    if (workers.length === 0) {\n        return;\n    }\n\n    const realms = _(workers)\n        .groupBy(worker => worker.level)\n        .map((workers, level) => {\n            const _level = Number(level);\n            return _(workers)\n                .groupBy(worker => worker.district.realm.name)\n                .map((workers, realmName) => ({\n                    realmName,\n                    level: _level,\n                    availableWorkers: workers,\n                    availableBuildings: _prepRestBuildings({\n                        accountName,\n                        buildings: findBuildings({\n                            buildings,\n                            realmName,\n                            level: _level,\n                            buildingSetName: 'bestRestBuildings'\n                        }),\n                        level: _level,\n                    }),\n                }))\n                .value();\n        })\n        .flatten()\n        .sortBy(realm => -realm.level)\n        .value();\n    \n    // processing one realm at once\n    const realm = realms.find(realm => realm.availableBuildings.length > 0);\n    \n    if (realm == null) {\n        log({\n            project: gameSettings.name,\n            message: `[SKILLED] No available rest buildings but ${workers.length} available workers`,\n        });\n        return null;\n    }\n\n    return _getStartMixedRestAction({\n        accountName,\n        exchange,\n        account,\n        gameSettings,\n        realm,\n        actionName: 'start_mixed_rests',\n    });\n};\n\nconst getStartMixedUnskilledRestAction = ({\n    accountName,\n    exchange,\n    account,\n    buildings,\n    workers,\n    gameSettings,\n}) => {\n    if (workers.length === 0) {\n        return;\n    }\n\n    const realms = _(workers)\n        .groupBy(worker => worker.district.realm.name)\n        .map((workers, realmName) => ({\n            realmName,\n            availableWorkers: workers,\n            availableBuildings: _prepRestBuildings({\n                accountName,\n                buildings: findBuildings({\n                    buildings,\n                    realmName,\n                    level: 1,\n                    buildingSetName: 'bestUnskilledRestBuildings'\n                }),\n                level: 1,\n            }),\n        }))\n        .value();\n    \n    // processing one realm at once\n    const realm = realms.find(realm => realm.availableBuildings.length > 0);\n    \n    if (realm == null) {\n        log({\n            project: gameSettings.name,\n            message: `[UNSKILLED] No available rest buildings but ${workers.length} available workers`,\n        });\n        return null;\n    }\n\n    return _getStartMixedRestAction({\n        accountName,\n        exchange,\n        account,\n        gameSettings,\n        realm,\n        actionName: 'start_mixed_unskilled_rests',\n    });\n};\n\n// -------------------------------------------------------- //\n// ---------                 RENT                ---------- //\n// -------------------------------------------------------- //\nconst getRenewRentAction = ({\n    accountName,\n    exchange,\n    account,\n    buildings,\n    gameSettings,\n}) => {\n    if (buildings.length === 0) {\n        return;\n    }\n\n    const lands = _(buildings)\n        .map(building => building.land)\n        .value();\n    \n    const totalCosts = sumResources({\n        resources: _(lands)\n            .map(land => land.config.plotRentAmount.costs)\n            .flatten()\n            .value(),\n    });\n\n    const nextState = exchangeResources({\n        accountName,\n        exchange,\n        balances: account.balances,\n        maxBalances: account.maxBalances,\n        requestedResources: totalCosts,\n    });\n\n    if (nextState.action === 'stop') {\n        log({\n            project: gameSettings.name,\n            message: nextState.message,\n        });\n        return null;\n    }\n\n    return {\n        action: 'renew_rent',\n        actions: [\n            ...nextState.actions,\n            renewRent({\n                accountName,\n                landIds: _(lands)\n                    .map(land => land.id)\n                    .value(),\n            }),\n        ],\n    };\n};\n\nconst getNextStateAfterRentLandStart = ({\n    prevState,\n    accountName,\n    landConfigs,\n    exchange,\n    account,\n}) => {\n    if (prevState.availableBuildings.length === 0) {\n        return;\n    }\n\n    if (prevState.availableLands.length === 0) {\n        return;\n    }\n\n    // find a suitable building for a next worker\n    const availableBuildings = _.cloneDeep(prevState.availableBuildings);\n    const availableLands = _.cloneDeep(prevState.availableLands);\n    const building = availableBuildings.pop();\n    const land = availableLands.pop();\n    const landConfig = _(landConfigs)\n        .sortBy(config => config.rentTime)\n        .value()[0];\n\n    // calculate total cost depends on land ownership\n    let totalCosts = [];\n    if (land.isOwnLand) {\n        if (!land.isAvailableForRent) {\n            totalCosts = [\n                ...landConfig.plotRentAmount.costs,\n            ];\n        }\n    } else {\n        totalCosts = [\n            ...land.rentCost.costs,\n        ];\n    }\n\n    const nextState = exchangeResources({\n        accountName,\n        exchange,\n        balances: prevState.resources,\n        maxBalances: account.maxBalances,\n        requestedResources: totalCosts,\n    });\n\n    if (nextState.action === 'stop') {\n        return nextState;\n    }\n\n    return {\n        action: land.isOwnLand\n            ? 'start_own_land_rent'\n            : 'start_external_land_rent',\n        actions: _.compact([\n            ...nextState.actions,\n            land.isOwnLand && !land.isAvailableForRent\n                ? setLandRent({\n                    accountName,\n                    id: land.id,\n                    rentObsd: 0,\n                    isOwnerOccupied: true,\n                    landConfigId: landConfig.id,\n                })\n                : null,\n            stakeBuilding({\n                accountName,\n                assetId: building.assetId,\n                realmId: land.realmId,\n                districtId: land.districtId,\n                landId: land.id,\n            }),\n        ]),\n        resources: sumResources({\n            resources: [\n                ...nextState.nextBalances,\n            ],\n        }),\n        availableBuildings,\n        availableLands,\n    };\n};\n\nconst getRentMixedLandsAction = ({\n    accountName,\n    exchange,\n    account,\n    lands,\n    buildings,\n    landConfigs,\n    gameSettings,\n}) => {\n    const qualifiedBuildings = _(buildings)\n        .filter(building => building.level >= MIN_RENT_BUILDING_LEVELS[building.config.resourceType])\n        .value();\n\n    if (qualifiedBuildings.length === 0) {\n        return;\n    }\n\n    const realms = _(qualifiedBuildings)\n        .groupBy(building => building.realmName)\n        .map((buildings, realmName) => ({\n            realmName,\n            availableBuildings: buildings,\n            availableLands: _(findLands({\n                lands,\n                realmName,\n                landSetName: 'bestLands',\n            }))\n                .map(land => ({\n                    id: land.id,\n                    realmId: land.district.realm.id,\n                    districtId: land.district.id,\n                    owner: land.owner,\n                    isOwnLand: land.owner === accountName,\n                    isAvailableForRent: land.isAvailableForRent,\n                    rentPriceObsd: land.rentPriceObsd,\n                    rentCost: land.rentCost,\n                }))\n                .filter(land => land.rentPriceObsd < MAX_LAND_RENT_PRICE_OBSD)\n                .sortBy(land => -land.rentPriceObsd)\n                .value(),\n        }))\n        .value();\n\n    // process one realm at a time\n    const realm = realms.find(realm => realm.availableLands.length > 0);\n\n    if (realm == null) {\n        log({\n            project: gameSettings.name,\n            message: `No available lands but ${qualifiedBuildings.length} available buildings: ${qualifiedBuildings.map(b => b.realmName).join(', ')}`,\n        });\n        return;\n    }\n\n    const states = [\n        {\n            action: 'init',\n            resources: account.balances,\n            availableBuildings: _.cloneDeep(realm.availableBuildings),\n            availableLands: _.cloneDeep(realm.availableLands),\n        },\n    ];\n\n    while (true) {\n        const prevState = states[states.length - 1];\n\n        if (prevState.availableBuildings.length === 0) {\n            break;\n        }\n        if (prevState.availableLands.length === 0) {\n            break;\n        }\n\n        const nextStateTransferExcessObsdToNovo = getNextStateAfterTransferExcessObsdToNovo({\n            prevState,\n            accountName,\n        });\n\n        if (nextStateTransferExcessObsdToNovo != null) {\n            states.push(nextStateTransferExcessObsdToNovo);\n            continue;\n        }\n\n        const nextStateAfterTransferAllResourecesToObsd = getNextStateAfterTransferAllResourecesToObsd({\n            prevState,\n            exchange,\n            accountName,\n        });\n\n        if (nextStateAfterTransferAllResourecesToObsd != null) {\n            states.push(nextStateAfterTransferAllResourecesToObsd);\n            continue;\n        }\n\n        const nextStateAfterRentLandStart = getNextStateAfterRentLandStart({\n            prevState,\n            accountName,\n            exchange,\n            landConfigs,\n            account,\n        });\n\n        if (nextStateAfterRentLandStart != null) {\n            if (nextStateAfterRentLandStart.action === 'stop') {\n                log({\n                    project: gameSettings.name,\n                    message: nextStateAfterRentLandStart.action.message,\n                });\n                break;\n            }\n\n            states.push(nextStateAfterRentLandStart);\n        }\n    }\n\n    const actions = _(states)\n        .map(state => state.actions)\n        .compact()\n        .flatten()\n        .value();\n\n    if (actions.length === 0) {\n        return;\n    }\n\n    return {\n        action: 'rent_mixed_lands',\n        isMultipleTransactions: true,\n        actions: _.chunk(actions, 16),\n    };\n};\n\n// -------------------------------------------------------- //\n// ---------               UPGRADE               ---------- //\n// -------------------------------------------------------- //\n\nconst getNextStateAfterStartWorkerUpgrade = ({\n    prevState,\n    accountName,\n    exchange,\n    account,\n}) => {\n    const settings = _.cloneDeep(prevState.settings);\n    const {\n        worker,\n        config,\n    } = settings.pop();\n\n    const nextState = exchangeResources({\n        accountName,\n        exchange,\n        balances: prevState.resources,\n        maxBalances: account.maxBalances,\n        requestedResources: config.upgradeCost.costs,\n    });\n\n    if (nextState.action === 'stop') {\n        return nextState;\n    }\n\n    return {\n        action: 'upgrading_workers',\n        actions: [\n            ...nextState.actions,\n            startUpgrade({\n                accountName,\n                assetId: worker.id,\n            }),\n        ],\n        resources: sumResources({\n            resources: [\n                ...nextState.nextBalances,\n            ],\n        }),\n        settings,\n    };\n};\n\nconst getStartWorkerUpgradesAction = ({\n    account,\n    exchange,\n    accountName,\n    upgradeConfigs,\n    workers,\n    gameSettings,\n}) => {\n    if (workers.length === 0) {\n        return;\n    }\n\n    const settings = _(workers)\n        .map(worker => ({\n            worker,\n            config: upgradeConfigs\n                .find(config => config.key === worker.realmName)\n                .configs\n                .find(config => config.baseLevel === worker.level),\n        }))\n        .value();\n\n    const states = [\n        {\n            action: 'init',\n            resources: account.balances,\n            settings: _.cloneDeep(settings),\n        },\n    ];\n\n    while(true) {\n        const prevState = states[states.length - 1];\n\n        if (prevState.settings.length === 0) {\n            break;\n        }\n\n        const nextStateTransferExcessObsdToNovo = getNextStateAfterTransferExcessObsdToNovo({\n            prevState,\n            accountName,\n        });\n\n        if (nextStateTransferExcessObsdToNovo != null) {\n            states.push(nextStateTransferExcessObsdToNovo);\n            continue;\n        }\n\n        const nextStateAfterTransferAllResourecesToObsd = getNextStateAfterTransferAllResourecesToObsd({\n            prevState,\n            exchange,\n            accountName,\n        });\n\n        if (nextStateAfterTransferAllResourecesToObsd != null) {\n            states.push(nextStateAfterTransferAllResourecesToObsd);\n            continue;\n        }\n\n        const nextStateAfterStartWorkerUpgrade = getNextStateAfterStartWorkerUpgrade({\n            prevState,\n            accountName,\n            exchange,\n            account,\n        });\n\n        if (nextStateAfterStartWorkerUpgrade != null) {\n            if (nextStateAfterStartWorkerUpgrade.action === 'stop') {\n                log({\n                    project: gameSettings.name,\n                    message: nextStateAfterStartWorkerUpgrade.action.message,\n                });\n                break;\n            }\n\n            states.push(nextStateAfterStartWorkerUpgrade);\n        }\n    }\n\n    const actions = _(states)\n        .map(state => state.actions)\n        .compact()\n        .flatten()\n        .value();\n    \n    if (actions.length === 0) {\n        return;\n    }\n    \n    return {\n        action: 'upgrade_workers',\n        isMultipleTransactions: true,\n        actions: _.chunk(actions, 16),\n    };\n};\n\nconst getFinishUpgradesAction = ({\n    accountName,\n    upgrades,\n}) => {\n    const now = Date.now();\n\n    const finishedUpgrades = _(upgrades)\n        .filter(upgrade => upgrade.owner === accountName)\n        .filter(upgrade => upgrade.endTime < now)\n        .value();\n\n    if (finishedUpgrades.length === 0) {\n        return;\n    }\n\n    return {\n        action: 'finish_upgrades',\n        actions: _(finishedUpgrades)\n            .map(upgrade => finishUpgrade({\n                accountName,\n                assetId: upgrade.assetId,\n            }))\n            .value(),\n    }\n};\n\n// -------------------------------------------------------- //\n// ---------             ENTRY POIN              ---------- //\n// -------------------------------------------------------- //\nconst playGameCalcNextAction = async ({\n    accountName,\n    gameSettings,\n}) => {\n    const {\n        exchange,\n        account,\n        accountBuildings,\n        accountWorkers,\n        accountLands,\n        accountTransfers,\n        landConfigs,\n        upgradeConfigs,\n        upgrades,\n    } = await fetchAllGameDat({\n        accountName,\n    });\n\n    // showing alert if some buildings places in district with inappropriate town hall level\n    if (accountBuildings.ownStaleBuildings.length > 0) {\n        const staleRealms = _(accountBuildings.ownStaleBuildings)\n            .map(building => building.district.realm.name)\n            .uniq()\n            .value();\n        log({\n            project: gameSettings.name,\n            message: `[ACTION NEEDED] ${accountBuildings.ownStaleBuildings.length} stale buildings, need to be moved to another district, relams: ${staleRealms.join(', ')}`,\n        });\n    }\n\n    // wake up all available workers\n    if (accountWorkers.readyToWakeupWorkers.length > 0) {\n        return {\n            action: 'wakeup',\n            actions: [\n                wakeupWorkers({\n                    accountName,\n                    workerIds: _(accountWorkers.readyToWakeupWorkers)\n                        .map(worker => worker.id)\n                        .value(),\n                }),\n            ],\n        };\n    }\n    \n    // set wage for all avaialbe buildings\n    if (accountBuildings.ownBuildingsWithoutWageSet.length > 0) {\n        return {\n            action: 'set_building_wage',\n            actions: _(accountBuildings.ownBuildingsWithoutWageSet)\n                .map(b => setBuildWage({\n                    accountName,\n                    id: b.id,\n                    wageObsd: b.config.minimumWage.obsdCost,\n                    isOnlyOwnWorkersAllowed: true,\n                    minWorkerLevel: 1,\n                }))\n                .value(),\n        };\n    }\n    \n    // prolong rent for buildings placed on your lands\n    if (accountBuildings.ownBuildingsExpiredExternalRentSet.length > 0) {\n        return {\n            action: 'cancel_external_rent',\n            actions: _(accountBuildings.ownBuildingsExpiredExternalRentSet)\n                .map(building => removeBuilding({\n                    accountName,\n                    buildingId: building.id,\n                }))\n                .value(),\n        };\n    }\n    const startMixedShiftsAction = getStartMixedShiftAction({\n        accountName,\n        exchange,\n        account,\n        buildings: accountBuildings.buildings,\n        workers: [\n            ...accountWorkers.readyToWorkWorkers,\n        ],\n        gameSettings,\n    });\n\n    const startMixedUnskilledShiftsAction = getStartMixedUnskilledShiftAction({\n        accountName,\n        exchange,\n        account,\n        buildings: accountBuildings.unskilledJobBuildings,\n        workers: accountWorkers.readyToWorkUnskilledWorkers,\n        gameSettings,\n    });\n\n    const startMixedUnskilledRestAction = getStartMixedUnskilledRestAction({\n        accountName,\n        exchange,\n        account,\n        buildings: accountBuildings.buildings,\n        workers: accountWorkers.readyToRestUnskilledWorkers,\n        gameSettings,\n    });\n    \n    const startMixedRestsAction = getStartMixedRestAction({\n        accountName,\n        exchange,\n        account,\n        buildings: accountBuildings.buildings,\n        workers: accountWorkers.readyToRestWorkers,\n        gameSettings,\n    });\n\n    const startRenewRentAction = getRenewRentAction({\n        accountName,\n        exchange,\n        account,\n        buildings: accountBuildings.ownBuildingsExpiredRentSet,\n        gameSettings,\n    });\n\n    const rentExternalLandsAction = getRentMixedLandsAction({\n        accountName,\n        exchange,\n        account,\n        lands: accountLands.lands,\n        buildings: accountTransfers.buildings,\n        landConfigs,\n        gameSettings,\n    });\n\n    const startWorkerUpgradesAction = getStartWorkerUpgradesAction({\n        account,\n        exchange,\n        accountName,\n        upgradeConfigs: upgradeConfigs.workers,\n        workers: accountWorkers.readyToUpgradeWorkers,\n        gameSettings,\n    });\n\n    const finishUpgradesAction = getFinishUpgradesAction({\n        accountName,\n        upgrades,\n    });\n\n    if (finishUpgradesAction != null) {\n        return finishUpgradesAction;\n    }\n\n    if (startWorkerUpgradesAction != null) {\n        return startWorkerUpgradesAction;\n    }\n\n    if (rentExternalLandsAction != null) {\n        return rentExternalLandsAction;\n    }\n    \n    if (startMixedRestsAction != null) {\n        return startMixedRestsAction;\n    }\n\n    if (startMixedUnskilledRestAction != null) {\n        return startMixedUnskilledRestAction;\n    }\n    \n    if (startRenewRentAction != null) {\n        return startRenewRentAction;\n    }\n\n    if (startMixedShiftsAction != null) {\n        return startMixedShiftsAction;\n    }\n\n    if (startMixedUnskilledShiftsAction != null) {\n        return startMixedUnskilledShiftsAction;\n    }\n\n    return {\n        action: 'wait',\n        message: `Nothing to do for ${accountName}`,\n    };\n};\n\nmodule.exports = playGameCalcNextAction;\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}