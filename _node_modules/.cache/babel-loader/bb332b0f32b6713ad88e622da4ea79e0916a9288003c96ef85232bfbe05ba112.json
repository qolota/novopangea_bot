{"ast":null,"code":"import _regeneratorRuntime from\"/Users/germangurov/projects/wax_bot/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"/Users/germangurov/projects/wax_bot/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _defineProperty from\"/Users/germangurov/projects/wax_bot/node_modules/@babel/runtime/helpers/esm/defineProperty.js\";var _URLS;var qs=require('query-string');var _=require('lodash');var sleep=require('../../utils/sleep');var API_ENDPOINTS=require('../consts/API_ENGPOINTS');var URLS=(_URLS={},_defineProperty(_URLS,API_ENDPOINTS.ASSETS,'https://wax.api.atomicassets.io/atomicmarket/v1/assets/'),_defineProperty(_URLS,API_ENDPOINTS.ACCOUNTS,'https://wax.api.atomicassets.io/atomicassets/v1/accounts/'),_defineProperty(_URLS,API_ENDPOINTS.SALES,'https://wax.api.atomicassets.io/atomicmarket/v2/sales/'),_defineProperty(_URLS,API_ENDPOINTS.TEMPLATES,'https://wax.api.atomicassets.io/atomicassets/v1/templates/'),_defineProperty(_URLS,API_ENDPOINTS.TEMPLATES_STATS,'https://wax.api.atomichub.io/atomicassets/v1/templates/${template_id}/stats'),_defineProperty(_URLS,API_ENDPOINTS.LOGS,'https://wax.api.atomicassets.io/atomicassets/v1/assets/${asset_id}/logs/'),_defineProperty(_URLS,API_ENDPOINTS.TRANSFERS,'https://wax.api.atomicassets.io/atomicassets/v1/transfers/'),_URLS);var MIN_POSTPONE_REQUEST_TIME=500;var postponeRequestTime=MIN_POSTPONE_REQUEST_TIME;var fetchAtomichub=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(_ref){var type,params,url,_param,atomicAssetsUrl,res,data;return _regeneratorRuntime().wrap(function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:type=_ref.type,params=_ref.params;url=URLS[type];_param=params;_context.t0=type;_context.next=_context.t0===API_ENDPOINTS.LOGS?6:9;break;case 6:url=url.replace('${asset_id}',params.asset_id);_param=_.omit(params,'asset_id');return _context.abrupt(\"break\",9);case 9:if(!(url==null)){_context.next=11;break;}throw new Error(\"Atomic hub utils: type \".concat(type,\" is not found\"));case 11:atomicAssetsUrl=\"\".concat(url,\"?\").concat(qs.stringify(_param));console.log(\"Loading [\".concat(type,\"] page=[\").concat(_param.page,\"] \").concat(atomicAssetsUrl));case 13:if(!true){_context.next=31;break;}_context.next=16;return fetch(atomicAssetsUrl,{headers:new Headers({mode:'no-cors'})});case 16:res=_context.sent;_context.next=19;return res.json();case 19:data=_context.sent;if(data.success){_context.next=27;break;}if(!(data.message==='Rate limit')){_context.next=26;break;}postponeRequestTime=postponeRequestTime*2;console.log(\"Wait \".concat(postponeRequestTime,\"ms befor making another AH request\"));_context.next=26;return sleep(postponeRequestTime);case 26:return _context.abrupt(\"continue\",13);case 27:postponeRequestTime=MIN_POSTPONE_REQUEST_TIME;return _context.abrupt(\"return\",data);case 31:case\"end\":return _context.stop();}},_callee);}));return function fetchAtomichub(_x){return _ref2.apply(this,arguments);};}();module.exports=fetchAtomichub;","map":{"version":3,"names":["qs","require","_","sleep","API_ENDPOINTS","URLS","_URLS","_defineProperty","ASSETS","ACCOUNTS","SALES","TEMPLATES","TEMPLATES_STATS","LOGS","TRANSFERS","MIN_POSTPONE_REQUEST_TIME","postponeRequestTime","fetchAtomichub","_ref2","_asyncToGenerator","_regeneratorRuntime","mark","_callee","_ref","type","params","url","_param","atomicAssetsUrl","res","data","wrap","_callee$","_context","prev","next","t0","replace","asset_id","omit","abrupt","Error","concat","stringify","console","log","page","fetch","headers","Headers","mode","sent","json","success","message","stop","_x","apply","arguments","module","exports"],"sources":["/Users/germangurov/projects/wax_bot/src/atomicassets/utils/fetchAtomichub.js"],"sourcesContent":["const qs = require('query-string');\nconst _ = require('lodash');\nconst sleep = require('../../utils/sleep');\nconst API_ENDPOINTS = require('../consts/API_ENGPOINTS');\n\nconst URLS = {\n    [API_ENDPOINTS.ASSETS]: 'https://wax.api.atomicassets.io/atomicmarket/v1/assets/',\n    [API_ENDPOINTS.ACCOUNTS]: 'https://wax.api.atomicassets.io/atomicassets/v1/accounts/',\n    [API_ENDPOINTS.SALES]: 'https://wax.api.atomicassets.io/atomicmarket/v2/sales/',\n    [API_ENDPOINTS.TEMPLATES]: 'https://wax.api.atomicassets.io/atomicassets/v1/templates/',\n    [API_ENDPOINTS.TEMPLATES_STATS]: 'https://wax.api.atomichub.io/atomicassets/v1/templates/${template_id}/stats',\n    [API_ENDPOINTS.LOGS]: 'https://wax.api.atomicassets.io/atomicassets/v1/assets/${asset_id}/logs/',\n    [API_ENDPOINTS.TRANSFERS]: 'https://wax.api.atomicassets.io/atomicassets/v1/transfers/',\n};\n\nconst MIN_POSTPONE_REQUEST_TIME = 500;\nlet postponeRequestTime = MIN_POSTPONE_REQUEST_TIME;\n\nconst fetchAtomichub = async ({\n    type,\n    params,\n}) => {\n    let url = URLS[type];\n    let _param = params;\n    switch (type) {\n        case API_ENDPOINTS.LOGS:\n            url = url.replace('${asset_id}', params.asset_id);\n            _param = _.omit(params, 'asset_id');\n            break;\n    }\n    if (url == null) {\n        throw new Error(`Atomic hub utils: type ${type} is not found`);\n    }\n    const atomicAssetsUrl = `${url}?${qs.stringify(_param)}`;\n    console.log(`Loading [${type}] page=[${_param.page}] ${atomicAssetsUrl}`);\n\n    while (true) {\n        const res = await fetch(atomicAssetsUrl, {\n            headers: new Headers({\n                mode: 'no-cors',\n            }),\n        });\n        const data = await res.json();\n        if (!data.success) {\n            if (data.message === 'Rate limit') {\n                postponeRequestTime = postponeRequestTime * 2;\n                console.log(`Wait ${postponeRequestTime}ms befor making another AH request`);\n                await sleep(postponeRequestTime);\n            }\n            \n            continue;\n        }\n\n        postponeRequestTime = MIN_POSTPONE_REQUEST_TIME;\n        return data;\n    }\n};\n\nmodule.exports = fetchAtomichub;\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}